<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  
  <title>Login Masitaprex | Registro y Acceso a la Infraestructura</title>
  <meta name="description" content="Acceso exclusivo a Masitaprex. Inicia sesi√≥n, realiza tu registro o recupera tu cuenta para gestionar cr√©ditos, APIs Dev y PeliPREX HD.">
  <meta name="keywords" content="login masitaprex, registro masitaprex, recuperar cuenta masitaprex, acceso masitaprex, comprar creditos masitaprex, paquetes masitaprex" />
  <meta name="robots" content="index, follow">

  <meta property="og:title" content="Acceso a Masitaprex | Gesti√≥n de Cuenta y Cr√©ditos" />
  <meta property="og:description" content="Ingresa a tu panel de control. Gestiona tus APIs de consulta, tus cr√©ditos y tu suscripci√≥n a la infraestructura de √©lite." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://masitaprex.com/login" />
  <meta property="og:image" content="https://cdn-icons-png.flaticon.com/128/747/747965.png" />
  <meta property="og:image:width" content="128" />
  <meta property="og:image:height" content="128" />

  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/747/747965.png">
  <link rel="shortcut icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/747/747965.png">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/128/747/747965.png">

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  
  <script src="https://www.google.com/recaptcha/api.js?render=explicit&onload=recaptchaOnLoad" async defer></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
        --primary: #007bff; 
        --secondary: #00e676; 
        --google-blue: #4285f4;
        --github-dark: #24292e;
        --accent: #ff4081;
        --button-gradient: linear-gradient(135deg, #0072ff 0%, #00e676 100%);
        --bg-gradient: radial-gradient(circle at top right, #fdfbfb 0%, #ebedee 100%);
        --text-dark: #1a1e2e;
        --text-muted: #64748b;
        --input-bg: rgba(241, 245, 249, 0.8);
        --btn-height: 58px;
        --radius: 22px;
    }

    * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        margin: 0;
        padding: 0;
    }

    body {
        margin: 0;
        padding: 0;
        font-family: 'Poppins', sans-serif;
        background: var(--bg-gradient);
        color: var(--text-dark);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
    }

    #app-container {
        width: 100%;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .screen {
        width: 100%;
        max-width: 480px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Estilos T√≠tulos */
    h3 {
        font-weight: 800;
        font-size: 2.4rem;
        margin-bottom: 8px;
        text-align: center;
        background: var(--button-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -1px;
    }

    .form-subtitle {
        text-align: center;
        color: var(--text-muted);
        font-size: 1rem;
        margin-bottom: 32px;
        font-weight: 400;
    }

    /* Inputs Nativo-Style */
    .input-group {
        width: 100%;
        margin-bottom: 16px;
        position: relative;
    }

    .input-field {
        width: 100%;
        height: 62px;
        padding: 0 20px 0 54px;
        font-size: 1rem;
        border: 2px solid transparent;
        border-radius: var(--radius);
        background: var(--input-bg);
        color: var(--text-dark);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-family: 'Inter', sans-serif;
    }

    .input-field:focus {
        background: #fff;
        border-color: var(--primary);
        box-shadow: 0 10px 25px -5px rgba(0, 114, 255, 0.15);
        outline: none;
    }

    .field-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 22px;
        transition: color 0.3s;
    }

    .input-field:focus + .field-icon {
        color: var(--primary);
    }

    .password-toggle {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: var(--text-muted);
        padding: 4px;
        user-select: none;
        transition: color 0.3s;
    }

    .password-toggle:hover {
        color: var(--primary);
    }

    /* Botones Pro */
    .primary-btn, .recover-btn {
        width: 100%;
        height: var(--btn-height);
        background: var(--button-gradient);
        color: #fff;
        border: none;
        border-radius: var(--radius);
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin: 12px 0;
        box-shadow: 0 12px 24px -6px rgba(0, 114, 255, 0.4);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .primary-btn:active, .recover-btn:active {
        transform: scale(0.97);
        box-shadow: 0 4px 10px rgba(0, 114, 255, 0.2);
    }

    .register-btn {
        width: 100%;
        height: var(--btn-height);
        background: white;
        color: var(--primary);
        border: 2px solid #e2e8f0;
        border-radius: var(--radius);
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-top: 8px;
    }

    .register-btn:active {
        background: #f8fafc;
        border-color: var(--primary);
    }

    /* Welcome Screen Buttons */
    .btn {
        width: 100%;
        height: var(--btn-height);
        border-radius: var(--radius);
        font-weight: 600;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
        transition: all 0.3s ease;
    }

    .btn-primary-gradient {
        background: #fff;
        border: 2px solid #0072ff;
        color: #0072ff;
    }

    .btn-google { background: white; border: 1px solid #e2e8f0; color: #444; }
    .btn-github { background: #24292e; border: none; color: #fff; }
    .btn-login-red { background: #fee2e2; border: none; color: #dc2626; }

    /* Forms container */
    .login-form, .register-form, .recover-password-form {
        display: none;
        flex-direction: column;
        width: 100%;
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .separator {
        display: flex;
        align-items: center;
        margin: 24px 0;
        color: #94a3b8;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .separator::before, .separator::after {
        content: '';
        flex: 1;
        height: 1px;
        background: #e2e8f0;
    }

    .separator span { padding: 0 15px; }

    .text-link {
        text-align: center;
        margin-top: 12px;
        font-size: 0.95rem;
    }

    .text-link a {
        color: var(--primary);
        font-weight: 600;
        text-decoration: none;
    }

    /* ReCAPTCHA centering */
    .recaptcha-container {
        display: flex;
        justify-content: center;
        margin: 10px 0;
        transform: scale(0.9);
    }

    /* Modal 3D modern */
    .modal-3d {
        background: white;
        padding: 32px;
        border-radius: 30px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .welcome-icon {
        font-size: 80px;
        background: var(--button-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 20px;
    }

    /* NUEVO: Modal de mensajes profesional */
    .message-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 50000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeInOverlay 0.3s ease-out;
    }

    .message-modal-overlay.show {
        display: flex;
    }

    @keyframes fadeInOverlay {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideInModal {
        from {
            opacity: 0;
            transform: translate(-50%, -48%) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
    }

    @keyframes slideOutModal {
        from {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        to {
            opacity: 0;
            transform: translate(-50%, -48%) scale(0.9);
        }
    }

    .message-modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 24px;
        padding: 32px 24px;
        width: 90%;
        max-width: 360px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        text-align: center;
        animation: slideInModal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .message-modal-content.closing {
        animation: slideOutModal 0.3s ease-out forwards;
    }

    .message-modal-icon {
        font-size: 56px;
        margin-bottom: 16px;
    }

    .message-modal-text {
        font-size: 16px;
        font-weight: 500;
        color: #334155;
        line-height: 1.5;
        margin: 0;
    }

    @media (max-width: 480px) {
        h3 { font-size: 2rem; }
        .screen { padding: 20px; }
    }
  </style>
</head>
<body>
  <div id="app-container">
    
    <div id="welcome-screen" class="screen" style="display: flex;">
        <img src="https://cdn-icons-png.flaticon.com/128/17202/17202358.png" alt="Seguridad" style="width: 80px; height: 80px; margin-bottom: 20px;">
        <h1 class="text-4xl font-extrabold mb-2 tracking-tight">Masitaprex</h1>
        <p class="text-slate-500 mb-10 text-center px-6">Acceso exclusivo a la infraestructura de alto rendimiento.</p>
        
        <button class="btn btn-primary-gradient" onclick="showRegisterFormFromWelcome()">
          <span class="material-icons">person_add</span>
          <span>Crear cuenta gratis</span>
        </button>
        
        <div class="w-full flex items-center my-4">
            <div class="flex-1 h-px bg-slate-200"></div>
            <span class="px-3 text-xs text-slate-400 font-bold uppercase">O accede con</span>
            <div class="flex-1 h-px bg-slate-200"></div>
        </div>

        <button class="btn btn-google" onclick="signInWithGoogle()">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" width="20">
          <span>Continuar con Google</span>
        </button>
        
        <button class="btn btn-github" onclick="signInWithGithub()">
          <svg width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.042-1.416-4.042-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>
          <span>Acceder con GitHub</span>
        </button>
        
        <button class="btn btn-login-red" onclick="showLoginFormFromWelcome()">
          <span class="material-icons">login</span>
          <span>Ingreso tradicional</span>
        </button>

        <div class="mt-8 text-xs text-slate-400 font-medium text-center">
            <p class="mb-2">Antes de iniciar sesi√≥n en nuestra infraestructura tecnol√≥gica, es importante que leas detenidamente nuestros T√©rminos y Pol√≠tica de Privacidad.</p>
            <div class="flex gap-4 justify-center">
                <a href="politica-privacidad.html">Privacidad</a>
                <span>‚Ä¢</span>
                <a href="terminos-condiciones.html">T√©rminos</a>
            </div>
        </div>
    </div>

    <div id="login-screen" class="screen" style="display: none;">
      <div id="login-form" class="login-form">
          <h3 style="font-size: 2rem;">Bienvenido</h3>
          <p class="form-subtitle">Ingresa tus credenciales para acceder</p>
          
          <div class="input-group">
              <span class="material-icons field-icon">alternate_email</span>
              <input type="email" id="login-email" placeholder="Email" class="input-field">
          </div>
          
          <div class="input-group">
              <span class="material-icons field-icon">lock_outline</span>
              <input type="password" id="login-password" placeholder="Contrase√±a" class="input-field">
              <span class="material-icons password-toggle" onclick="togglePasswordVisibility('login-password', this)">visibility</span>
          </div>
          
          <div class="recaptcha-container">
              <div id="login-recaptcha"></div>
          </div>
          
          <button class="primary-btn" onclick="loginWithEmail()">
              <span>Iniciar Sesi√≥n</span>
          </button>
          
          <div class="text-link">
              <a href="#" onclick="showRecoverPasswordForm(); return false;">¬øProblemas para entrar? Recuperar</a>
          </div>
          
          <div class="separator"><span>o</span></div>
          
          <button class="register-btn" onclick="showRegisterForm()">No tengo cuenta, registrarme</button>
      </div>

      <div id="register-form" class="register-form">
          <h3 style="font-size: 2rem;">Crear cuenta</h3>
          <p class="form-subtitle">Forma parte de nuestra comunidad</p>
          
          <div class="input-group">
              <span class="material-icons field-icon">person_outline</span>
              <input type="text" id="register-name" placeholder="Nombre completo" class="input-field">
          </div>
          
          <div class="input-group">
              <span class="material-icons field-icon">mail_outline</span>
              <input type="email" id="register-email" placeholder="Email institucional" class="input-field">
          </div>
          
          <div class="input-group">
              <span class="material-icons field-icon">lock_open</span>
              <input type="password" id="register-password" placeholder="Contrase√±a (m√≠n. 6)" class="input-field">
              <span class="material-icons password-toggle" onclick="togglePasswordVisibility('register-password', this)">visibility</span>
          </div>
          
          <div class="input-group">
              <span class="material-icons field-icon">shield</span>
              <input type="password" id="register-confirm-password" placeholder="Confirmar contrase√±a" class="input-field">
              <span class="material-icons password-toggle" onclick="togglePasswordVisibility('register-confirm-password', this)">visibility</span>
          </div>
          
          <div class="recaptcha-container">
              <div id="register-recaptcha"></div>
          </div>
          
          <button class="primary-btn" onclick="openTermsModal()">
              <span>Registrarse ahora</span>
          </button>
          
          <div class="text-link">
              ¬øYa eres miembro? <a href="#" onclick="showLoginForm(); return false;">Inicia sesi√≥n</a>
          </div>
      </div>

      <div id="recover-password-form" class="recover-password-form">
          <div class="text-center mb-6">
              <span class="material-icons text-blue-500 text-6xl">key</span>
          </div>
          <h3 style="font-size: 2rem;">¬øOlvidaste tu clave?</h3>
          <p class="form-subtitle">Enviaremos instrucciones a tu correo</p>
          
          <div class="input-group">
              <span class="material-icons field-icon">mark_email_read</span>
              <input type="email" id="recover-email" placeholder="Email registrado" class="input-field">
          </div>
          
          <button class="recover-btn" onclick="recoverPassword()">
              <span>Enviar enlace de recuperaci√≥n</span>
          </button>
          
          <div class="text-link">
              <a href="#" onclick="showLoginForm(); return false;" class="flex items-center justify-center gap-2">
                  <span class="material-icons text-sm">arrow_back</span> Volver al inicio
              </a>
          </div>
      </div>
    </div>
  </div>

  <div id="terms-modal" class="modal-overlay fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[20000] hidden flex items-center justify-center p-4">
    <div class="modal-3d animate-in zoom-in duration-300">
        <div class="flex flex-col items-center text-center">
            <span class="material-icons text-5xl text-emerald-500 mb-4">verified</span>
            <h4 class="text-xl font-bold mb-2">T√©rminos de Servicio</h4>
            <div class="bg-slate-50 p-4 rounded-2xl text-sm text-slate-600 mb-6 text-left border border-slate-100">
                Al registrarte, confirmas que eres mayor de edad y que har√°s un uso responsable de los servicios de Masitaprex. No se permiten actividades il√≠citas.
            </div>
            <label class="flex items-start gap-3 mb-6 cursor-pointer group">
                <input type="checkbox" id="accept-terms-check" class="mt-1 w-5 h-5 accent-blue-600 rounded">
                <span class="text-sm text-slate-500 text-left group-hover:text-slate-700 transition-colors">Acepto los t√©rminos y el aviso de privacidad de datos.</span>
            </label>
            <button id="confirm-terms-btn" class="primary-btn !m-0 disabled:opacity-50 disabled:shadow-none" disabled>
                Confirmar Registro
            </button>
            <button onclick="closeTermsModal()" class="mt-4 text-sm font-semibold text-slate-400">Quiz√°s m√°s tarde</button>
        </div>
    </div>
  </div>

  <!-- NUEVO: Modal de mensajes amigables -->
  <div id="message-modal" class="message-modal-overlay">
    <div id="message-modal-content" class="message-modal-content">
      <div id="message-modal-icon" class="message-modal-icon">
        <span class="material-icons" style="font-size: 56px; color: #3b82f6;">info</span>
      </div>
      <p id="message-modal-text" class="message-modal-text"></p>
    </div>
  </div>
  
  <div id="loading-indicator" class="fixed inset-0 bg-white/90 backdrop-blur-md z-[10000] hidden items-center justify-center">
      <div class="flex gap-2">
          <div class="w-4 h-4 rounded-full bg-blue-600 animate-bounce"></div>
          <div class="w-4 h-4 rounded-full bg-emerald-500 animate-bounce [animation-delay:-.3s]"></div>
          <div class="w-4 h-4 rounded-full bg-blue-600 animate-bounce [animation-delay:-.5s]"></div>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
      onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, 
      GithubAuthProvider, signInWithPopup, sendEmailVerification, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getFirestore, doc, setDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    let auth, db;
    let recaptchaSiteKey = "6LeV3losAAAAALQDaPn_mVmUP7Z6el879PcfRmzo";
    let appConfig;
    
    let loginRecaptchaWidgetId = null;
    let registerRecaptchaWidgetId = null;
    let recaptchaRefreshTimer = null;

    const loadingIndicator = document.getElementById('loading-indicator');
    const welcomeScreen = document.getElementById('welcome-screen');
    const loginScreen = document.getElementById('login-screen');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const recoverPasswordForm = document.getElementById('recover-password-form');
    const termsModal = document.getElementById('terms-modal');
    const termsCheck = document.getElementById('accept-terms-check');
    const confirmTermsBtn = document.getElementById('confirm-terms-btn');

    // NUEVO: Sistema de mensajes amigables
    const messageModal = document.getElementById('message-modal');
    const messageModalContent = document.getElementById('message-modal-content');
    const messageModalIcon = document.getElementById('message-modal-icon');
    const messageModalText = document.getElementById('message-modal-text');

    // ‚úÖ Generar deviceId √∫nico
    function getDeviceId() {
        let deviceId = localStorage.getItem('deviceId');
        if (!deviceId) {
            deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('deviceId', deviceId);
        }
        return deviceId;
    }

    function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // ‚úÖ Funci√≥n de redirecci√≥n usando returnTo y sessionStorage
    function redirectAfterAuth(user) {
        if (user && !user.emailVerified) {
            window.location.href = "verificacion.html";
            return;
        }

        let returnTo = getUrlParameter('returnTo');
        if (!returnTo || returnTo === 'null' || returnTo === 'undefined') {
            returnTo = sessionStorage.getItem('returnTo');
        }

        if (returnTo) {
            try {
                const decodedUrl = decodeURIComponent(returnTo);
                if (decodedUrl.startsWith('/') && !decodedUrl.includes('//')) {
                    sessionStorage.removeItem('returnTo');
                    window.location.href = decodedUrl;
                    return;
                }
            } catch (e) {
                console.warn('URL de retorno inv√°lida:', e);
            }
        }
        
        window.location.href = "actividad";
    }

    // Funci√≥n para convertir errores t√©cnicos a mensajes amigables
    function getFriendlyErrorMessage(error) {
        const errorCode = error.code || '';
        const errorMessage = error.message || '';
        
        const errorMessages = {
            'auth/email-already-in-use': 'Este correo ya est√° registrado. Intenta iniciar sesi√≥n o usa otro correo.',
            'auth/invalid-email': 'El formato del correo electr√≥nico no es v√°lido.',
            'auth/operation-not-allowed': 'Esta operaci√≥n no est√° permitida en este momento.',
            'auth/weak-password': 'La contrase√±a es muy d√©bil. Usa al menos 6 caracteres.',
            'auth/user-disabled': 'Esta cuenta ha sido deshabilitada.',
            'auth/user-not-found': 'No existe una cuenta con este correo electr√≥nico.',
            'auth/wrong-password': 'Contrase√±a incorrecta. Por favor verifica tus datos.',
            'auth/invalid-credential': 'Las credenciales proporcionadas son incorrectas.',
            'auth/too-many-requests': 'Demasiados intentos fallidos. Intenta m√°s tarde.',
            'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet e intenta nuevamente.',
            'auth/popup-closed-by-user': 'Has cerrado la ventana de autenticaci√≥n.',
            'auth/cancelled-popup-request': 'Operaci√≥n cancelada.',
            'auth/popup-blocked': 'El navegador bloque√≥ la ventana emergente. Permite ventanas emergentes e intenta nuevamente.',
            'auth/account-exists-with-different-credential': 'Ya existe una cuenta con este correo usando otro m√©todo de acceso.',
            'auth/invalid-verification-code': 'El c√≥digo de verificaci√≥n no es v√°lido.',
            'auth/invalid-verification-id': 'El ID de verificaci√≥n no es v√°lido.',
            'auth/missing-verification-code': 'Falta el c√≥digo de verificaci√≥n.',
            'auth/missing-verification-id': 'Falta el ID de verificaci√≥n.',
            'auth/requires-recent-login': 'Por seguridad, debes iniciar sesi√≥n nuevamente.',
            'auth/expired-action-code': 'El c√≥digo ha expirado. Solicita uno nuevo.',
            'auth/invalid-action-code': 'El c√≥digo no es v√°lido. Solicita uno nuevo.',
        };

        if (errorMessages[errorCode]) {
            return errorMessages[errorCode];
        }

        if (errorMessage.toLowerCase().includes('firebase')) {
            return 'Ocurri√≥ un error inesperado. Por favor intenta nuevamente.';
        }

        return 'Ha ocurrido un problema. Intenta nuevamente en unos momentos.';
    }

    // Funci√≥n para mostrar modal de mensajes
    function showMessageModal(message, type = 'info') {
        const iconElement = messageModalIcon.querySelector('.material-icons');
        
        const icons = {
            'success': { icon: 'check_circle', color: '#10b981' },
            'error': { icon: 'error', color: '#ef4444' },
            'info': { icon: 'info', color: '#3b82f6' },
            'warning': { icon: 'warning', color: '#f59e0b' }
        };

        const iconConfig = icons[type] || icons.info;
        iconElement.textContent = iconConfig.icon;
        iconElement.style.color = iconConfig.color;
        
        messageModalText.textContent = message;
        messageModal.classList.add('show');
        messageModalContent.classList.remove('closing');

        setTimeout(() => {
            closeMessageModal();
        }, 3000);
    }

    // Funci√≥n para cerrar el modal
    function closeMessageModal() {
        messageModalContent.classList.add('closing');
        setTimeout(() => {
            messageModal.classList.remove('show');
            messageModalContent.classList.remove('closing');
        }, 300);
    }

    messageModal.addEventListener('click', (e) => {
        if (e.target === messageModal) {
            closeMessageModal();
        }
    });

    function showLoadingOverlay() { loadingIndicator.style.display = 'flex'; }
    function hideLoadingOverlay() { loadingIndicator.style.display = 'none'; }

    function hideAllForms() {
        if (loginForm) loginForm.style.display = 'none';
        if (registerForm) registerForm.style.display = 'none';
        if (recoverPasswordForm) recoverPasswordForm.style.display = 'none';
    }

    window.goToWelcomeScreen = function() {
        welcomeScreen.style.display = 'flex';
        loginScreen.style.display = 'none';
        hideAllForms();
    };

    window.showLoginFormFromWelcome = function() {
        welcomeScreen.style.display = 'none';
        loginScreen.style.display = 'flex';
        showLoginForm();
    };

    window.showRegisterFormFromWelcome = function() {
        welcomeScreen.style.display = 'none';
        loginScreen.style.display = 'flex';
        showRegisterForm();
    };

    window.openTermsModal = () => {
        const name = document.getElementById('register-name')?.value;
        const email = document.getElementById('register-email')?.value;
        const password = document.getElementById('register-password')?.value;
        
        const recaptchaResponse = grecaptcha.getResponse(registerRecaptchaWidgetId);
        if (!recaptchaResponse) {
            showMessageModal('Por favor, verifica que no eres un robot', 'warning');
            return;
        }
        
        if (!name || !email || !password) {
            showMessageModal('Completa todos los campos antes de continuar', 'warning');
            return;
        }
        
        termsModal.style.display = 'flex';
    };

    window.closeTermsModal = () => {
        termsModal.style.display = 'none';
    };

    window.showTermsModal = function() {
        termsModal.style.display = 'flex';
        if (termsCheck) termsCheck.checked = false;
        if (confirmTermsBtn) confirmTermsBtn.disabled = true;
    };

    if (termsCheck) {
        termsCheck.addEventListener('change', () => {
            if (confirmTermsBtn) confirmTermsBtn.disabled = !termsCheck.checked;
        });
    }

    if (confirmTermsBtn) {
        confirmTermsBtn.addEventListener('click', () => {
            closeTermsModal();
            registerNewAccount();
        });
    }

    window.recaptchaOnLoad = function() {
        if (loginForm?.style.display === 'flex') {
            initLoginRecaptcha();
        } else if (registerForm?.style.display === 'flex') {
            initRegisterRecaptcha();
        }
    };

    function initLoginRecaptcha() {
        if (loginRecaptchaWidgetId !== null) {
            grecaptcha.reset(loginRecaptchaWidgetId);
            return;
        }
        const container = document.getElementById('login-recaptcha');
        if (container && window.grecaptcha) {
            loginRecaptchaWidgetId = grecaptcha.render(container, {
                'sitekey': recaptchaSiteKey,
                'theme': 'light',
                'callback': () => startRecaptchaRefreshTimer(loginRecaptchaWidgetId)
            });
        }
    }

    function initRegisterRecaptcha() {
        if (registerRecaptchaWidgetId !== null) {
            grecaptcha.reset(registerRecaptchaWidgetId);
            return;
        }
        const container = document.getElementById('register-recaptcha');
        if (container && window.grecaptcha) {
            registerRecaptchaWidgetId = grecaptcha.render(container, {
                'sitekey': recaptchaSiteKey,
                'theme': 'light',
                'callback': () => startRecaptchaRefreshTimer(registerRecaptchaWidgetId)
            });
        }
    }

    function startRecaptchaRefreshTimer(widgetId) {
        if (recaptchaRefreshTimer) clearTimeout(recaptchaRefreshTimer);
        recaptchaRefreshTimer = setTimeout(() => {
            if (widgetId !== null && window.grecaptcha) {
                grecaptcha.reset(widgetId);
                startRecaptchaRefreshTimer(widgetId);
            }
        }, 50000);
    }

    window.showRegisterForm = () => {
        hideAllForms();
        if (registerForm) registerForm.style.display = 'flex';
        setTimeout(() => initRegisterRecaptcha(), 100);
    };

    window.showLoginForm = () => {
        hideAllForms();
        if (loginForm) loginForm.style.display = 'flex';
        setTimeout(() => initLoginRecaptcha(), 100);
    };

    window.showRecoverPasswordForm = () => {
        hideAllForms();
        if (recoverPasswordForm) recoverPasswordForm.style.display = 'flex';
        if (recaptchaRefreshTimer) {
            clearTimeout(recaptchaRefreshTimer);
            recaptchaRefreshTimer = null;
        }
    };

    window.togglePasswordVisibility = (inputId, icon) => {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
            input.type = 'text';
            icon.textContent = 'visibility_off';
        } else {
            input.type = 'password';
            icon.textContent = 'visibility';
        }
    };

    async function validateRecaptchaWithBackend(recaptchaResponse) {
        try {
            const response = await fetch('/api/validate-recaptcha', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ recaptchaResponse })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Error validando reCAPTCHA');
            return data.success;
        } catch (error) {
            console.error('Error validando reCAPTCHA:', error);
            throw error;
        }
    }

    async function initFirebase() {
      try {
        const response = await fetch('/api/config');
        appConfig = await response.json();
        const app = initializeApp(appConfig.firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        if (appConfig.recaptchaSiteKey) {
            recaptchaSiteKey = appConfig.recaptchaSiteKey;
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            if (user.emailVerified) {
                redirectAfterAuth(user);
            } else {
                const returnTo = getUrlParameter('returnTo');
                const verificationUrl = returnTo ? `verificacion.html?returnTo=${encodeURIComponent(returnTo)}` : "verificacion.html";
                window.location.href = verificationUrl;
            }
          } else {
            setTimeout(() => {
                goToWelcomeScreen();
                hideLoadingOverlay();
            }, 500);
          }
        });
      } catch (error) {
        console.error("Error al cargar configuraci√≥n:", error);
        setTimeout(() => {
            goToWelcomeScreen();
            hideLoadingOverlay();
        }, 500);
      }
    }

    initFirebase();

    // ================================================================
    // ‚úÖ SOLUCI√ìN DEFINITIVA: keepalive: true + await + delays
    // ================================================================
    async function notifyBackendWelcomeEmail(user) {
        console.log('[üîî NOTIFY] Iniciando notificaci√≥n backend', {
            uid: user.uid,
            email: user.email,
            displayName: user.displayName
        });

        try {
            if (!user || !user.uid || !user.email) {
                console.warn('[‚ö†Ô∏è NOTIFY] Datos incompletos');
                return;
            }

            // ‚úÖ keepalive: true asegura que la petici√≥n NO se cancele al redirigir
            const response = await fetch('/api/notify-verification', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || null
                }),
                keepalive: true  // ‚úÖ CLAVE: Mantiene la petici√≥n viva despu√©s de redirect
            });

            console.log('[üì• NOTIFY] Respuesta recibida', {
                status: response.status,
                ok: response.ok
            });

            if (response.ok) {
                const data = await response.json();
                console.log('[‚úÖ NOTIFY] Correo enviado exitosamente', data);
            } else {
                console.error('[‚ùå NOTIFY] Error del servidor:', response.status);
            }

        } catch (err) {
            console.error('[‚ùå NOTIFY] Error en petici√≥n:', err.message);
        }
    }

    // ================================================================
    // ‚úÖ GOOGLE LOGIN: await + delay 500ms + delay 1000ms
    // ================================================================
    window.signInWithGoogle = async function() {
        try {
            showLoadingOverlay();
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            
            console.log('[üîµ GOOGLE] Iniciando autenticaci√≥n...');
            const result = await signInWithPopup(auth, provider);
            console.log('[üîµ GOOGLE] Login exitoso:', result.user.email);

            // 1. Guardar perfil
            await saveUserProfile(result.user, result.user.displayName);
            console.log('[üîµ GOOGLE] Perfil guardado');

            // 2. ‚úÖ Notificar al backend (con keepalive)
            console.log('[üîµ GOOGLE] Notificando backend...');
            await notifyBackendWelcomeEmail(result.user);
            
            // 3. ‚úÖ Delay de seguridad 500ms
            console.log('[üîµ GOOGLE] Delay seguridad 500ms...');
            await new Promise(resolve => setTimeout(resolve, 500));

            // 4. Mostrar mensaje
            showMessageModal('Inicio de sesi√≥n exitoso', 'success');
            
            // 5. ‚úÖ Delay antes de redirecci√≥n 1000ms
            console.log('[üîµ GOOGLE] Delay pre-redirect 1000ms...');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 6. Redirigir
            console.log('[üîµ GOOGLE] Redirigiendo...');
            redirectAfterAuth(result.user);
            
        } catch (error) {
            console.error('[‚ùå GOOGLE] Error:', error);
            hideLoadingOverlay();
            showMessageModal(getFriendlyErrorMessage(error), 'error');
        }
    };

    // ================================================================
    // ‚úÖ GITHUB LOGIN: await + delay 500ms + delay 1000ms
    // ================================================================
    window.signInWithGithub = async function() {
        try {
            showLoadingOverlay();
            const provider = new GithubAuthProvider();
            provider.setCustomParameters({ allow_signup: 'true' });
            
            console.log('[‚ö´ GITHUB] Iniciando autenticaci√≥n...');
            const result = await signInWithPopup(auth, provider);
            console.log('[‚ö´ GITHUB] Login exitoso:', result.user.email);

            // 1. Guardar perfil
            await saveUserProfile(result.user, result.user.displayName);
            console.log('[‚ö´ GITHUB] Perfil guardado');

            // 2. ‚úÖ Notificar al backend (con keepalive)
            console.log('[‚ö´ GITHUB] Notificando backend...');
            await notifyBackendWelcomeEmail(result.user);
            
            // 3. ‚úÖ Delay de seguridad 500ms
            console.log('[‚ö´ GITHUB] Delay seguridad 500ms...');
            await new Promise(resolve => setTimeout(resolve, 500));

            // 4. Mostrar mensaje
            showMessageModal('Inicio de sesi√≥n exitoso', 'success');
            
            // 5. ‚úÖ Delay antes de redirecci√≥n 1000ms
            console.log('[‚ö´ GITHUB] Delay pre-redirect 1000ms...');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 6. Redirigir
            console.log('[‚ö´ GITHUB] Redirigiendo...');
            redirectAfterAuth(result.user);
            
        } catch (error) {
            console.error('[‚ùå GITHUB] Error:', error);
            hideLoadingOverlay();
            showMessageModal(getFriendlyErrorMessage(error), 'error');
        }
    };

    // ================================================================
    // ‚úÖ LOGIN CON EMAIL - CORREGIDO: NO REPORTAR FALLOS SI ES EXITOSO
    // ================================================================
    window.loginWithEmail = async () => {
      const email = document.getElementById('login-email')?.value;
      const password = document.getElementById('login-password')?.value;
      
      if (!email || !password) { 
          showMessageModal('Por favor completa todos los campos', 'warning');
          return; 
      }
      
      const recaptchaResponse = grecaptcha.getResponse(loginRecaptchaWidgetId);
      if (!recaptchaResponse) { 
          showMessageModal('Por favor, verifica que no eres un robot', 'warning');
          return; 
      }
      
      showLoadingOverlay();
      
      try {
          // ‚úÖ 1. VALIDAR CON EL BACKEND ANTES DE FIREBASE
          const deviceId = getDeviceId();
          const returnTo = getUrlParameter('returnTo') || sessionStorage.getItem('returnTo') || '';
          
          const backendResponse = await fetch('/api/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  email,
                  password,
                  recaptchaResponse,
                  returnTo,
                  deviceId
              })
          });

          const backendData = await backendResponse.json();

          // ‚úÖ 2. SI EL BACKEND DEVUELVE ERROR account_blocked, DETENER
          if (!backendResponse.ok) {
              hideLoadingOverlay();
              if (loginRecaptchaWidgetId !== null) grecaptcha.reset(loginRecaptchaWidgetId);

              if (backendData.error === 'account_blocked') {
                  const hoursRemaining = Math.ceil(backendData.remainingMinutes / 60);
                  showMessageModal(
                      `Tu cuenta est√° bloqueada por seguridad debido a m√∫ltiples intentos fallidos. Intenta nuevamente en ${hoursRemaining} hora(s).`,
                      'error'
                  );
                  return;
              }

              showMessageModal(backendData.error || 'Error en la validaci√≥n', 'error');
              return;
          }

          // ‚úÖ 3. SI EL BACKEND RESPONDE OK, CONTINUAR CON FIREBASE AUTH
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          await saveUserProfile(userCredential.user);
          
          // ‚úÖ 4. LOGIN EXITOSO - NO REPORTAR COMO FALLO
          hideLoadingOverlay();
          
          if (!userCredential.user.emailVerified) {
              const verificationUrl = returnTo ? `verificacion.html?returnTo=${encodeURIComponent(returnTo)}` : "verificacion.html";
              window.location.href = verificationUrl;
          } else {
              redirectAfterAuth(userCredential.user);
          }

      } catch (error) {
          hideLoadingOverlay();
          if (loginRecaptchaWidgetId !== null) grecaptcha.reset(loginRecaptchaWidgetId);

          // ‚úÖ 5. SOLO REPORTAR SI REALMENTE FALL√ì LA AUTENTICACI√ìN
          const errorCode = error.code || '';
          
          if (errorCode === 'auth/invalid-credential' || 
              errorCode === 'auth/wrong-password' || 
              errorCode === 'auth/user-not-found') {
              
              // ‚úÖ REPORTAR INTENTO FALLIDO AL BACKEND
              try {
                  const reportResponse = await fetch('/api/report-failed-login', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ email })
                  });

                  const reportData = await reportResponse.json();

                  if (reportData.success) {
                      const remainingAttempts = reportData.maxAttempts - reportData.currentAttempts;
                      
                      if (reportData.isBlocked) {
                          const hoursRemaining = Math.ceil(reportData.remainingMinutes / 60);
                          showMessageModal(
                              `Tu cuenta ha sido bloqueada por seguridad. Intenta nuevamente en ${hoursRemaining} hora(s).`,
                              'error'
                          );
                      } else {
                          showMessageModal(
                              `Credenciales incorrectas. Te quedan ${remainingAttempts} intentos antes de que tu cuenta sea bloqueada por seguridad.`,
                              'error'
                          );
                      }
                  } else {
                      showMessageModal(getFriendlyErrorMessage(error), 'error');
                  }
              } catch (reportError) {
                  console.error('Error reportando intento fallido:', reportError);
                  showMessageModal(getFriendlyErrorMessage(error), 'error');
              }
          } else {
              showMessageModal(getFriendlyErrorMessage(error), 'error');
          }
      }
    };

    window.registerNewAccount = async () => {
      const name = document.getElementById('register-name')?.value;
      const email = document.getElementById('register-email')?.value;
      const password = document.getElementById('register-password')?.value;
      const confirm = document.getElementById('register-confirm-password')?.value;
      
      if (password !== confirm) { 
          showMessageModal('Las contrase√±as no coinciden. Verifica e intenta nuevamente.', 'error');
          return; 
      }
      
      const recaptchaResponse = grecaptcha.getResponse(registerRecaptchaWidgetId);
      if (!recaptchaResponse) { 
          showMessageModal('Por favor, verifica que no eres un robot', 'warning');
          return; 
      }
      
      showLoadingOverlay();
      try {
          await validateRecaptchaWithBackend(recaptchaResponse);
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          await saveUserProfile(userCredential.user, name);
          
          const returnTo = getUrlParameter('returnTo');
          if (returnTo) {
              sessionStorage.setItem('returnTo', returnTo);
          }
          
          fetch('/api/send-verification-email', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                  email: userCredential.user.email,
                  name: name || userCredential.user.displayName || userCredential.user.email.split('@')[0]
              })
          }).catch(err => console.error('Error fetch email:', err));
          
          showMessageModal('Cuenta creada exitosamente. Revisa tu correo para verificar tu cuenta.', 'success');
          setTimeout(() => {
              window.location.href = "verificacion.html";
          }, 2000);
      } catch (error) {
          hideLoadingOverlay();
          if (registerRecaptchaWidgetId !== null) grecaptcha.reset(registerRecaptchaWidgetId);
          showMessageModal(getFriendlyErrorMessage(error), 'error');
      }
    };

    window.recoverPassword = async () => {
        const email = document.getElementById('recover-email')?.value;
        
        if (!email) { 
            showMessageModal('Por favor ingresa tu correo electr√≥nico', 'warning');
            return; 
        }
        
        showLoadingOverlay();
        try {
            await sendPasswordResetEmail(auth, email);
            hideLoadingOverlay();
            showMessageModal('Hemos enviado un enlace de recuperaci√≥n a tu correo. Revisa tu bandeja de entrada.', 'success');
            setTimeout(() => showLoginForm(), 3000);
        } catch (error) {
            hideLoadingOverlay();
            showMessageModal(getFriendlyErrorMessage(error), 'error');
        }
    };

    async function saveUserProfile(user, name = null) {
      try {
        const userDocRef = doc(db, "users", user.uid);
        await setDoc(userDocRef, {
          email: user.email,
          name: name || user.displayName || user.email.split('@')[0],
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        }, { merge: true });
      } catch (e) { 
          console.error('Error perfil:', e); 
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const returnTo = getUrlParameter('returnTo');
        if (returnTo) {
            sessionStorage.setItem('returnTo', returnTo);
        }
        
        hideAllForms();
        showLoadingOverlay();
    });
  </script>
</body>
</html>
