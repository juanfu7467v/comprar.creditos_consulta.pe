<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago Seguro - Consulta PE</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
        .mp-container { height: 48px; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 12px; background: white; margin-bottom: 1rem; }
        #form-checkout__submit:disabled { background-color: #93c5fd; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-lg bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
        <div id="payment-form-container">
            <h2 class="text-2xl font-extrabold mb-2 text-center text-blue-900">Finalizar Compra</h2>
            <div id="loading-config" class="text-center text-blue-600 font-bold py-4">Cargando configuración segura...</div>
            
            <div id="main-ui" class="hidden">
                <div class="mb-8 p-5 bg-blue-50 rounded-xl border border-blue-100">
                    <div class="flex justify-between mb-2"><span>Paquete:</span><span id="display-description" class="font-bold"></span></div>
                    <div class="flex justify-between"><span>Total:</span><span id="display-amount" class="text-2xl font-black"></span></div>
                </div>

                <form id="form-checkout">
                    <div id="form-checkout__cardNumber" class="mp-container"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div id="form-checkout__expirationDate" class="mp-container"></div>
                        <div id="form-checkout__securityCode" class="mp-container"></div>
                    </div>
                    <input type="text" id="form-checkout__cardholderName" class="w-full p-3 border border-gray-200 rounded-lg mb-4" placeholder="Nombre en la tarjeta" />
                    <select id="form-checkout__issuer" class="w-full p-3 border border-gray-200 rounded-lg mb-4"></select>
                    <select id="form-checkout__installments" class="w-full p-3 border border-gray-200 rounded-lg mb-4"></select>
                    <input type="email" id="form-checkout__cardholderEmail" class="w-full p-3 border border-gray-200 rounded-lg mb-6" />
                    <button type="submit" id="form-checkout__submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl">Confirmar Pago</button>
                </form>
            </div>
        </div>

        <div id="status-screen" class="hidden text-center py-10">
            <div id="loading-status">Procesando...</div>
            <div id="success-status" class="hidden">
                <h3 class="text-2xl font-bold text-green-600">¡Pago Exitoso!</h3>
                <button onclick="generateInvoice()" id="generate-btn" class="mt-4 bg-gray-800 text-white p-3 rounded">Descargar Comprobante</button>
            </div>
            <div id="error-status" class="hidden text-red-600"></div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const amount = urlParams.get('amount');
        const uid = urlParams.get('uid');
        const email = urlParams.get('email');
        const description = urlParams.get('description') || 'Créditos';

        async function init() {
            try {
                // 1. OBTENER LA PUBLIC KEY DESDE EL SERVIDOR (SECRETS)
                const response = await fetch('/api/config');
                const config = await response.json();
                
                if (!config.mercadopagoPublicKey) throw new Error("No se encontró Public Key");

                document.getElementById('loading-config').classList.add('hidden');
                document.getElementById('main-ui').classList.remove('hidden');
                document.getElementById('display-amount').textContent = `S/ ${amount}`;
                document.getElementById('display-description').textContent = description;
                document.getElementById('form-checkout__cardholderEmail').value = email;

                // 2. INICIALIZAR MERCADO PAGO
                const mp = new MercadoPago(config.mercadopagoPublicKey);
                const cardForm = mp.cardForm({
                    amount: amount,
                    iframe: true,
                    form: {
                        id: "form-checkout",
                        cardNumber: { id: "form-checkout__cardNumber" },
                        expirationDate: { id: "form-checkout__expirationDate" },
                        securityCode: { id: "form-checkout__securityCode" },
                        cardholderName: { id: "form-checkout__cardholderName" },
                        issuer: { id: "form-checkout__issuer" },
                        installments: { id: "form-checkout__installments" },
                        cardholderEmail: { id: "form-checkout__cardholderEmail" },
                    },
                    callbacks: {
                        onSubmit: async (event) => {
                            event.preventDefault();
                            const formData = cardForm.getCardFormData();
                            document.getElementById('payment-form-container').classList.add('hidden');
                            document.getElementById('status-screen').classList.remove('hidden');

                            const res = await fetch("/api/pay", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ ...formData, uid, description })
                            });
                            const result = await res.json();
                            if (result.status === 'approved') {
                                window.currentPaymentId = result.id;
                                document.getElementById('loading-status').classList.add('hidden');
                                document.getElementById('success-status').classList.remove('hidden');
                            } else {
                                document.getElementById('error-status').textContent = "Pago rechazado";
                                document.getElementById('error-status').classList.remove('hidden');
                            }
                        }
                    }
                });
            } catch (e) {
                document.getElementById('loading-config').textContent = "Error al cargar configuración.";
                console.error(e);
            }
        }

        async function generateInvoice() {
            const res = await fetch("/api/generate-invoice", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentId: window.currentPaymentId, type: 'boleta' })
            });
            const data = await res.json();
            if (data.pdfUrl) window.open(data.pdfUrl, '_blank');
        }

        init();
    </script>
</body>
</html>
