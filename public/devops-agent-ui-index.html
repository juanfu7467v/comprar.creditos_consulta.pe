<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps Agent Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
        body { background-color: #0f172a; color: #f8fafc; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto space-y-6">
        <header class="flex flex-col md:flex-row justify-between items-center glass p-6 rounded-2xl border border-slate-700">
            <div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">
                    <i class="fas fa-robot mr-2"></i>DevOps Agent Autonomous
                </h1>
                <p class="text-slate-400 text-sm">Control centralizado de infraestructura y c√≥digo</p>
            </div>
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div id="health-badge" class="flex items-center bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                    <span id="health-dot" class="status-dot bg-slate-500 mr-2"></span>
                    <span id="health-text" class="text-xs font-mono uppercase">Checking...</span>
                </div>
                <input type="password" id="api-key" placeholder="Ingresa tu x-api-key" 
                    class="bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none w-64">
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 space-y-6">
                <section class="glass p-6 rounded-2xl border border-slate-700">
                    <h2 class="text-lg font-semibold mb-4"><i class="fas fa-terminal mr-2 text-blue-400"></i>Ejecutar Instrucci√≥n</h2>
                    <textarea id="instruction-input" rows="4" 
                        class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-slate-300 focus:ring-2 focus:ring-blue-500 outline-none mb-4"
                        placeholder="Ej: Crea una app de Next.js en mi GitHub y despli√©gala en Vercel..."></textarea>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input type="text" id="repo-context" placeholder="Nombre del repo (opcional)" class="bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-sm">
                        <select id="deploy-context" class="bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-sm">
                            <option value="none">Sin despliegue</option>
                            <option value="vercel">Vercel</option>
                            <option value="flyio">Fly.io</option>
                        </select>
                    </div>

                    <button onclick="executeAgent()" id="btn-execute" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center">
                        <i class="fas fa-play mr-2"></i>Enviar a DeepSeek
                    </button>
                </section>

                <section class="glass p-6 rounded-2xl border border-slate-700 min-h-[300px]">
                    <h2 class="text-lg font-semibold mb-4"><i class="fas fa-list-ul mr-2 text-emerald-400"></i>Salida del Agente</h2>
                    <div id="output-console" class="font-mono text-sm space-y-2 max-h-96 overflow-y-auto p-4 bg-black rounded-xl border border-slate-800">
                        <p class="text-slate-500">> Esperando instrucciones...</p>
                    </div>
                </section>
            </div>

            <div class="space-y-6">
                <section class="glass p-6 rounded-2xl border border-slate-700">
                    <h2 class="text-lg font-semibold mb-4"><i class="fas fa-plug mr-2 text-amber-400"></i>Conectores Activos</h2>
                    <div id="connectors-list" class="space-y-3">
                        <p class="text-slate-500 text-sm">Cargando conectores...</p>
                    </div>
                </section>

                <section class="glass p-6 rounded-2xl border border-slate-700 flex flex-col h-[400px]">
                    <h2 class="text-lg font-semibold mb-4"><i class="fas fa-comments mr-2 text-purple-400"></i>Chat R√°pido</h2>
                    <div id="chat-box" class="flex-grow overflow-y-auto space-y-3 mb-4 text-sm scrollbar-hide">
                        <div class="bg-slate-800 p-3 rounded-lg text-slate-300">¬°Hola! Soy tu asistente DevOps. ¬øEn qu√© te ayudo hoy?</div>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="Pregunta algo..." 
                            class="flex-grow bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none">
                        <button onclick="sendChatMessage()" class="bg-purple-600 px-4 py-2 rounded-lg hover:bg-purple-500">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </section>
            </div>

        </div>
    </div>

    <script>
        const BASE_URL = 'https://devops-agent-aut-nomo---plan-de.fly.dev';
        
        // Cargar API Key desde localstorage
        const apiKeyInput = document.getElementById('api-key');
        apiKeyInput.value = localStorage.getItem('agent_api_key') || '';
        apiKeyInput.addEventListener('change', (e) => localStorage.setItem('agent_api_key', e.target.value));

        // Verificaci√≥n de Salud
        async function checkHealth() {
            try {
                const res = await fetch(`${BASE_URL}/health`);
                const data = await res.json();
                if (data.status === 'up') {
                    document.getElementById('health-dot').className = 'status-dot bg-emerald-500 shadow-[0_0_8px_#10b981]';
                    document.getElementById('health-text').innerText = 'Online';
                    loadConnectors();
                }
            } catch (err) {
                document.getElementById('health-dot').className = 'status-dot bg-red-500';
                document.getElementById('health-text').innerText = 'Offline';
            }
        }

        // Cargar Conectores
        async function loadConnectors() {
            const apiKey = apiKeyInput.value;
            if (!apiKey) return;
            try {
                const res = await fetch(`${BASE_URL}/api/connectors`, {
                    headers: { 'x-api-key': apiKey }
                });
                const data = await res.json();
                const list = document.getElementById('connectors-list');
                list.innerHTML = '';
                
                if (data.connectors && Object.keys(data.connectors).length > 0) {
                    Object.keys(data.connectors).forEach(key => {
                        list.innerHTML += `
                            <div class="flex justify-between items-center bg-slate-800 p-2 rounded-lg border border-slate-700">
                                <span class="capitalize text-sm"><i class="fab fa-${key} mr-2"></i> ${key}</span>
                                <span class="text-[10px] bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded">Activo</span>
                            </div>`;
                    });
                } else {
                    list.innerHTML = '<p class="text-slate-500 text-xs text-center">No hay conectores vinculados.</p>';
                }
            } catch (err) { console.error(err); }
        }

        // Ejecutar Agente Aut√≥nomo
        async function executeAgent() {
            const instruction = document.getElementById('instruction-input').value;
            const repo = document.getElementById('repo-context').value;
            const deploy = document.getElementById('deploy-context').value;
            const apiKey = apiKeyInput.value;
            const consoleBox = document.getElementById('output-console');

            if (!apiKey) return alert('¬°Falta la API Key!');
            if (!instruction) return alert('Escribe una instrucci√≥n.');

            consoleBox.innerHTML += `<p class="text-blue-400 font-bold mt-4">>> Enviando: ${instruction}</p>`;
            const btn = document.getElementById('btn-execute');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Procesando...';

            try {
                const res = await fetch(`${BASE_URL}/api/v1/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey },
                    body: JSON.stringify({ 
                        instruction, 
                        context: { repo_name: repo, deployment: deploy } 
                    })
                });
                const result = await res.json();
                
                if (result.success) {
                    consoleBox.innerHTML += `<p class="text-emerald-400">‚úîÔ∏è Respuesta: ${JSON.stringify(result.data)}</p>`;
                } else {
                    consoleBox.innerHTML += `<p class="text-red-400">‚ùå Error: ${result.error}</p>`;
                }
            } catch (err) {
                consoleBox.innerHTML += `<p class="text-red-500">‚ùå Error de conexi√≥n.</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play mr-2"></i>Enviar a DeepSeek';
                consoleBox.scrollTop = consoleBox.scrollHeight;
            }
        }

        // Chat R√°pido
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const chatBox = document.getElementById('chat-box');
            const msg = input.value;
            const apiKey = apiKeyInput.value;

            if (!msg || !apiKey) return;

            chatBox.innerHTML += `<div class="bg-blue-600/20 p-3 rounded-lg text-blue-200 self-end">T√∫: ${msg}</div>`;
            input.value = '';

            try {
                const res = await fetch(`${BASE_URL}/api/agent/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                chatBox.innerHTML += `<div class="bg-slate-800 p-3 rounded-lg text-slate-300">ü§ñ: ${data.response || 'Procesado'}</div>`;
            } catch (err) {
                chatBox.innerHTML += `<div class="bg-red-900/20 p-3 rounded-lg text-red-400">Error de conexi√≥n</div>`;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Iniciar chequeo
        setInterval(checkHealth, 10000);
        checkHealth();
    </script>
</body>
</html>
