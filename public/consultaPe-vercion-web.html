<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Checkout Native - Consulta PE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- SDK de Mercado Pago -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <!-- jsPDF para generar PDFs en el frontend - VERSIÓN CORREGIDA con jsDelivr -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <!-- Lucide para iconos del menú -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #1a1a1a;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            /* Ajuste global para evitar desbordamientos */
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .app-container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            border: 1px solid #edf2f7;
        }

        /* Estilos mejorados para el grupo de búsqueda */
        .search-group {
            display: flex;
            flex-direction: column;
            background: white;
            border: 1.5px solid #dc2626; /* Borde rojo */
            border-radius: 14px;
            overflow: hidden;
            transition: border-color 0.2s;
        }

        .search-group:focus-within {
            border-color: #b91c1c; /* Rojo más oscuro al enfocar */
        }

        .native-select {
            appearance: none;
            background: #dc2626; /* Fondo rojo */
            border: none;
            /* Sin borde inferior para que parezca unido */
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: white; /* Texto blanco */
            width: 100%;
            outline: none;
            cursor: pointer;
            border-radius: 14px 14px 0 0; /* Bordes redondeados solo arriba */
        }

        /* Estilo para las opciones del select (no todos los navegadores lo soportan) */
        .native-select option {
            background: white;
            color: #1a1a1a;
        }

        .native-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            border: none;
            outline: none;
            border-radius: 0 0 14px 14px; /* Bordes redondeados solo abajo */
        }

        .native-input:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .btn-action {
            background-color: #dc2626;
            color: white;
            font-weight: 700;
            padding: 16px;
            border-radius: 14px;
            text-align: center;
            width: 100%;
            transition: opacity 0.2s;
        }

        .btn-action:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        .credit-card-preview {
            background: linear-gradient(145deg, #1a2639 0%, #0f4c5c 50%, #2a4f5e 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            position: relative;
            aspect-ratio: 1.6/1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            box-shadow: 0 20px 30px -10px rgba(0,0,0,0.4), inset 0 1px 2px rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .credit-card-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
            border-radius: 16px 16px 0 0;
            pointer-events: none;
        }

        .item-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .item-img {
            width: 60px;
            height: 60px;
            background: #f1f5f9;
            border-radius: 12px;
            object-fit: cover;
        }

        .qty-badge {
            background: #fef2f2;
            color: #dc2626;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
        }

        .plan-detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .plan-detail-table td {
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .plan-detail-table td:last-child {
            text-align: right;
            font-weight: 600;
        }
        .plan-detail-table tr:last-child td {
            border-bottom: none;
        }
        .plan-badge {
            background-color: #fef2f2;
            color: #dc2626;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
        }

        .card-chip {
            width: 50px;
            height: 38px;
            background: linear-gradient(145deg, #e9d59a 0%, #c9a73d 30%, #9e7c24 70%, #cab055 100%);
            border-radius: 8px;
            position: relative;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 5px #ffeeaa, inset 0 -3px 5px #4a3e1a, 0 3px 5px rgba(0,0,0,0.3);
            border: 1px solid #dcb85c;
            transform: rotate(2deg);
        }
        
        .card-chip::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            width: 12px;
            height: 8px;
            background: #ead7a0;
            border-radius: 2px;
            box-shadow: 0 0 8px #ffecb3, inset 0 0 2px #aa8f4a;
            border: 1px solid #b4984a;
            z-index: 2;
        }
        
        .card-chip .chip-dots {
            position: absolute;
            bottom: 7px;
            right: 7px;
            display: flex;
            gap: 3px;
        }
        .card-chip .chip-dots span {
            width: 5px;
            height: 5px;
            background: #a58734;
            border-radius: 50%;
            box-shadow: inset 0 1px 2px #4a3e1a;
        }
        
        .card-chip::after {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(45deg, transparent, transparent 4px, rgba(0,0,0,0.1) 4px, rgba(0,0,0,0.1) 8px);
            border-radius: 8px;
            pointer-events: none;
        }

        .services-slider {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            padding: 8px 0 20px 0;
            scrollbar-width: thin;
            scrollbar-color: #dc2626 #f1f5f9;
            -webkit-overflow-scrolling: touch;
        }
        .services-slider::-webkit-scrollbar {
            height: 6px;
        }
        .services-slider::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .services-slider::-webkit-scrollbar-thumb {
            background: #dc2626;
            border-radius: 10px;
        }

        .service-card {
            flex: 0 0 180px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #edf2f7;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .service-card:hover {
            transform: scale(1.02);
        }

        .service-card a {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .service-image {
            height: 120px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .service-image::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to top, white, transparent);
            pointer-events: none;
        }

        .service-text {
            padding: 16px 12px 12px 12px;
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            line-height: 1.4;
            min-height: 70px;
            background: white;
        }

        .service-img-1 { background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiMUakrMP-yKpoycaGvjK4APon-CjrN80pLn1CkZvz2NcS_XT98tdJA0MeF3EO3Bd7OUoTWIrubwHN2df7VKHHUnIX6_RYv_mfqT4uXRa1IUhsr52TDRBs4hJsHdRj2sSA7v52rC8TX3nDwdq7DBNDyBxQyiKbEJoFzzDdPcMC4_sYc5tCHvEu-8Qz3yM85/s400/1000088610.png'); }
        .service-img-2 { background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEguRbsfCLL-xBxn9uetDfATcrWZ9VyZU4VIF0HSg9cENRRc8cYvnRNksWqbpHnG4xWPNc_hyX2hd60FkUgxyci3XJS-yEX0lSLsPRSsa9a7uTuQrcYlVl2yG2EAJPdozEb4N8GofyWEaXcmLpeTL_uKYBGYg-nB5Dx9AAshOZlE8WePlsMdhO_KMlKtYWoI/s1536/1000092464.png'); }
        .service-img-3 { background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifNMAy4k9FFdDT96JpFiktrjRpRJz_Quq3lIrHz1t_NdKTZtU6NfMYzmkNGOVtwUg2hdfSZm0lN5SFp5j4LvDZCSd9QUNP8UUS9k_aGvdZ3Tj9W8DhzDFSdTWZJlRHsJ_OraOpFHWtX8wvKVM1oCpj3ggPZKEYMbuGSav51DbbTnZ3dUYSZTnipiJ57nyq/s1408/1000089677.png'); }
        .service-img-4 { background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh70yJXLIfwpXtzLtgHx0BVxSViptyqoQfWEUFpYc1YAKjiz3rOLGftFapScVR2aCgZ3DmjrEajHpCRyXumrR8cWBbLvDmO2NnsClUyyffhEWEnJ6ONXBGpPm4_wsuUjZHSh_yrZqH_D5ZTmqeeaE18gFpZq2JQWnuyQdHiHFhk52cYM9fvbk2mr0rHo0e_/s1536/1000086970.png'); }
        .service-img-5 { background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg-rRE_S7Oc-2mpFvjPmVCF2lhF3CXj1RaD-ahss2QgNDhpzZ1nCMCwa_9pxr8jlYom3pM5v3i13i4gzM7oJsc526ye7mh8bU1FoHjXbb4_Sr7UP38Ko3PTwe46mKVYaO6wHqzNtK8gVxBkqquo-J_do8nxlvM77Un3V1SzKG8JJP7sA8wQsr2XFPU9l8y6/s400/1000086971.png'); }

        .footer {
            background-color: #111111;
            color: #ffffff;
            width: 100%;
            padding: 40px 20px;
            margin-top: 16px;
            font-size: 14px;
            line-height: 1.6;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .footer-section {
            margin-bottom: 20px;
        }

        .footer-section h3 {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.01em;
        }

        .footer-section p {
            color: #a0a0a0;
            margin-bottom: 10px;
            max-width: 800px;
        }

        .footer-section strong {
            color: #ffffff;
            font-weight: 600;
        }

        .social-icons {
            display: flex;
            gap: 16px;
            margin-top: 20px;
        }

        .social-icons a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: #222222;
            border-radius: 50%;
            color: #ffffff;
            text-decoration: none;
            transition: all 0.2s;
            font-size: 18px;
        }

        .social-icons a:hover {
            background-color: #dc2626;
            transform: scale(1.05);
        }

        .top-icons {
            filter: blur(0);
            image-rendering: crisp-edges;
            transform: scale(1);
        }

        .resultado-wrap {
            background: #ffffff;
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            border: 1px solid #edf2f7;
            overflow: hidden;
            display: none;
        }

        .resultado-header {
            position: relative;
            padding: 22px 20px 12px 20px;
            background: #ffffff;
        }

        .resultado-header::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(115deg, #eef1f5 0%, #eef1f5 55%, #ffffff 55%, #ffffff 100%);
            z-index: 0;
        }

        .resultado-header-inner {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
        }

        .resultado-title {
            line-height: 1;
        }

        .resultado-title .resultado-text {
            font-weight: 800;
            font-size: 42px;
            letter-spacing: -0.02em;
            color: #0b0b0b;
        }

        .resultado-title .sub {
            margin-top: 6px;
            font-weight: 800;
            font-size: 26px;
            letter-spacing: 0.02em;
            color: #0b0b0b;
        }

        .resultado-logo {
            text-align: center;
            color: #0b0b0b;
            padding-top: 6px;
            min-width: 140px;
        }

        .resultado-logo .logo-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 4px auto;
            background-color: #2563eb;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .resultado-logo .logo-text {
            font-size: 14px;
            font-weight: 500;
        }

        .resultado-body {
            padding: 18px 20px 20px 20px;
            background: #ffffff;
        }

        .resultado-section-title {
            font-size: 18px;
            font-weight: 800;
            color: #0b0b0b;
            margin: 16px 0 10px 0;
        }

        .resultado-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #9aa3af;
            font-size: 14px;
            color: #111827;
        }

        .resultado-table td {
            border: 1px solid #9aa3af;
            padding: 12px 10px;
            vertical-align: middle;
        }

        .resultado-table .center {
            text-align: center;
        }

        .resultado-table.asistentes td:first-child {
            background: #f3f4f6;
            width: 50%;
            font-weight: 500;
        }

        .resultado-table.asistentes td:last-child {
            background: #ffffff;
            width: 50%;
        }

        .resultado-table.orden td {
            padding: 14px 12px;
        }

        .huella-img, .firma-img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }
        
        .foto-carnet {
            width: 100px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* ===== ESTILOS PARA PANTALLAS DE RESULTADO DE PAGO ===== */
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .payment-modal.active {
            display: flex;
        }

        .payment-modal-content {
            background: white;
            border-radius: 24px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .payment-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }

        .payment-modal-close:hover {
            color: #000;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            animation: scaleIn 0.5s ease-out;
        }

        .error-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            animation: scaleIn 0.5s ease-out;
        }

        .info-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            animation: scaleIn 0.5s ease-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .success-icon i, .error-icon i, .info-icon i {
            color: white;
            font-size: 40px;
        }

        .success-title {
            font-size: 24px;
            font-weight: 700;
            color: #10B981;
            text-align: center;
            margin-bottom: 8px;
        }

        .error-title {
            font-size: 24px;
            font-weight: 700;
            color: #EF4444;
            text-align: center;
            margin-bottom: 8px;
        }

        .info-title {
            font-size: 24px;
            font-weight: 700;
            color: #1E40AF;
            text-align: center;
            margin-bottom: 8px;
        }

        .info-table {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #666;
            font-size: 14px;
        }

        .info-value {
            font-weight: 600;
            color: #1a1a1a;
        }

        .info-value.highlight {
            color: #dc2626;
            font-size: 16px;
        }

        .confirmation-message {
            background: #D1FAE5;
            border: 1px solid #A7F3D0;
            border-radius: 12px;
            padding: 12px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .confirmation-message i {
            color: #10B981;
        }

        .confirmation-message span {
            color: #065F46;
            font-weight: 500;
        }

        .mp-container {
            height: 48px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            position: relative;
            width: 100%;
        }

        .mp-container.with-icon::before {
            content: '\f09d';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #9aa3af;
            font-size: 18px;
            z-index: 10;
            pointer-events: none;
        }

        .mp-container.with-icon-expiry::before {
            content: '\f073';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #9aa3af;
            font-size: 18px;
            z-index: 10;
            pointer-events: none;
        }

        .mp-container.with-icon-cvv::before {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #9aa3af;
            font-size: 18px;
            z-index: 10;
            pointer-events: none;
        }

        .mp-container iframe {
            padding-left: 45px !important;
            width: 100% !important;
        }

        .input-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 14px 16px;
            border: 1px solid #e2e8f0;
            width: 100%;
            font-size: 15px;
            transition: all 0.3s;
            text-align: center;
        }

        .input-box:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .grid-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
        }

        .document-container {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 15px;
            align-items: end;
            width: 100%;
        }

        .payment-btn {
            background: #dc2626;
            color: white;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .payment-btn:hover {
            background: #b91c1c;
        }

        .payment-btn:disabled {
            background: #9aa3af;
            cursor: not-allowed;
        }

        .security-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #9aa3af;
            font-size: 12px;
            margin-top: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            width: 100%;
        }

        .security-badge i {
            color: #10B981;
        }

        .total-price {
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 16px;
            text-align: right;
        }

        .hidden-field {
            display: none !important;
        }

        .hidden {
            display: none;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc2626;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .package-selector-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .package-selector-container .select-wrapper {
            flex: 1;
        }

        .package-selector-container .price-wrapper {
            width: 120px;
        }

        .card-payment-info {
            width: 100%;
            margin-bottom: 16px;
        }

        .card-payment-text {
            width: 100%;
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .card-icons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            width: 100%;
        }

        .card-icon-item {
            font-size: 32px;
            color: #475569;
            transition: transform 0.2s;
        }

        .card-icon-item:hover {
            transform: scale(1.1);
        }

        .card-more-box {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            background: #f8fafc;
            min-width: 60px;
            height: 32px;
        }

        .card-number-display {
            letter-spacing: 0.1em;
        }

        .expiry-input-wrapper {
            position: relative;
        }

        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px 0;
        }

        .loader-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb, #10b981);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .loader-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loader-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.6;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .download-voucher-btn {
            background: #10B981;
            color: white;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 16px;
        }

        .download-voucher-btn:hover {
            background: #059669;
        }

        .download-voucher-btn:disabled {
            background: #9aa3af;
            cursor: not-allowed;
        }

        .error-message {
            background: #FEE2E2;
            border: 1px solid #FCA5A5;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .error-message i {
            color: #EF4444;
            font-size: 20px;
        }

        .error-message-content {
            flex: 1;
        }

        .error-message-title {
            font-size: 14px;
            font-weight: 600;
            color: #EF4444;
            margin-bottom: 4px;
        }

        .error-message-text {
            font-size: 13px;
            color: #991B1B;
            line-height: 1.5;
        }

        /* Estilos para el modal de imágenes */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .image-modal-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            z-index: 2001;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
        }

        .image-modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .image-modal-prev,
        .image-modal-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 2001;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            transition: background 0.3s;
        }

        .image-modal-prev {
            left: 20px;
        }

        .image-modal-next {
            right: 20px;
        }

        .image-modal-prev:hover,
        .image-modal-next:hover {
            background: rgba(255,255,255,0.2);
        }

        .image-modal-prev.disabled,
        .image-modal-next.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .image-modal-prev.disabled:hover,
        .image-modal-next.disabled:hover {
            background: rgba(0,0,0,0.5);
        }

        .screenshot-img {
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .screenshot-img:hover {
            opacity: 0.8;
        }

        /* Estilos para el botón de descarga PDF (rojo, ancho completo) */
        .btn-pdf-download {
            background-color: #dc2626;
            color: white;
            font-weight: 700;
            padding: 16px;
            border-radius: 14px;
            text-align: center;
            width: 100%;
            margin-top: 20px;
            margin-bottom: 20px;
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-pdf-download:hover {
            background-color: #b91c1c;
        }

        .btn-pdf-download:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        .btn-pdf-download i {
            font-size: 18px;
        }

        /* ===== ESTILOS DEL MENÚ LATERAL (COPIADO DE APIs Doc) ===== */
        /* Overlay para el menú lateral */
        #sidebar-overlay { 
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: none;
        }

        #sidebar-overlay.opacity-100 {
            opacity: 1;
        }

        #sidebar-overlay.hidden {
            display: none;
        }

        /* Menú lateral principal */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 288px; /* w-72 = 288px */
            background: #000 !important; /* Fondo negro puro */
            color: #FFFFFF;
            z-index: 60;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.55);
            overflow-y: auto;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-100%);
            display: flex;
            flex-direction: column;
        }

        #sidebar.open {
            transform: translateX(0);
        }

        /* Encabezado del sidebar */
        .sidebar-header-bg {
            padding: 40px 24px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        /* Contenedor del icono del sidebar */
        .sidebar-header-bg > div:first-child {
            width: 72px;
            height: 72px;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header-bg img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar-header-bg h1, .sidebar-header-bg h2 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-top: 8px;
            color: #FFFFFF !important;
            letter-spacing: -0.025em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Decoración SVG en el encabezado */
        .sidebar-header-bg > div:last-child {
            position: absolute;
            top: 16px; /* top-4 = 16px */
            left: 16px; /* left-4 = 16px */
            opacity: 0.3;
        }

        /* Opciones del menú */
        #sidebar nav {
            padding: 16px 0;
            flex-grow: 1;
        }

        #sidebar nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            color: rgba(255, 255, 255, 0.8) !important;
            transition: all 0.2s ease;
            text-decoration: none;
            border-left: 4px solid transparent;
            margin-bottom: 2px;
        }

        #sidebar nav a:hover {
            background-color: rgba(255, 255, 255, 0.08);
            color: #FFFFFF !important;
            border-left-color: #FF1F3D;
        }

        #sidebar nav a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: #FFFFFF !important;
            border-left-color: #FF1F3D;
            font-weight: 600;
        }

        /* Iconos del menú */
        #sidebar nav i {
            width: 24px;
            height: 24px;
            stroke-width: 2;
            color: inherit;
            flex-shrink: 0;
        }

        /* Estilos para el texto del menú */
        #sidebar nav span {
            font-size: 1.125rem; /* text-lg = 18px */
        }

        /* Estilos responsivos */
        @media (max-width: 640px) {
            #sidebar {
                width: 280px;
            }
        }

        @media (max-width: 480px) {
            #sidebar {
                width: 100%;
                max-width: 300px;
            }
        }

        /* Ajustes para scrollbar en navegadores WebKit */
        #sidebar::-webkit-scrollbar {
            width: 6px;
        }

        #sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background: rgba(109, 91, 255, 0.5);
            border-radius: 3px;
        }

        #sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(109, 91, 255, 0.7);
        }

        /* Estilos para el footer de redes sociales dentro del sidebar */
        #sidebar .social-footer {
            padding: 20px 24px 30px 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            flex-shrink: 0;
        }

        #sidebar .social-footer a {
            display: inline-block;
            margin: 0 12px;
            color: #FFFFFF !important;
            font-size: 1.8rem;
            opacity: 0.8;
            transition: opacity 0.2s ease;
            text-decoration: none;
        }

        #sidebar .social-footer a:hover {
            opacity: 1;
        }

        /* Botón de hamburguesa */
        #menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(30, 58, 138, 0.9);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        #menu-toggle:hover {
            transform: scale(1.05);
            background: rgba(30, 58, 138, 1);
        }

        /* ===== ESTILOS PARA LA NUEVA SECCIÓN FAQ (ACORDEÓN) ===== */
        .faq-item {
            border-bottom: 1px solid #edf2f7;
            padding: 4px 0;
        }

        .faq-question {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            font-weight: 600;
            color: #1e293b;
            font-size: 16px;
            transition: color 0.2s;
        }

        .faq-question:hover {
            color: #dc2626;
        }

        .faq-question i {
            transition: transform 0.3s ease;
            color: #dc2626;
            flex-shrink: 0;
            margin-left: 16px;
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: #fafafa;
            border-radius: 12px;
            margin: 0 0 8px 0;
        }

        .faq-answer-content {
            padding: 16px;
            color: #334155;
            font-size: 14px;
            line-height: 1.6;
            border-left: 3px solid #dc2626;
            background: #fafafa; /* Cambiado a color de fondo uniforme */
            border-radius: 8px;
        }

        .faq-answer-content p {
            margin: 8px 0;
        }

        .faq-answer-content ul, .faq-answer-content ol {
            padding-left: 20px;
            margin: 8px 0;
        }

        .faq-answer-content li {
            margin: 4px 0;
        }

        .faq-answer-content strong {
            color: #1e293b;
        }
    </style>
</head>
<body>
    <!-- Botón de apertura del menú (ícono superior izquierdo) -->
    <button id="menu-toggle">
        <i data-lucide="menu"></i>
    </button>

    <!-- Overlay para el menú lateral -->
    <div id="sidebar-overlay" class="hidden"></div>

    <!-- Menú lateral principal (COPIADO COMPLETO DE APIs Doc) -->
    <aside id="sidebar">
        <div class="sidebar-header-bg">
            <!-- Icono del sidebar -->
            <div>
               
    <img src="https://cdn-icons-png.flaticon.com/128/747/747965.png" alt="Icono masitaprex">

            </div>
            <h1>masitaprex</h1>
            <!-- Decoración SVG -->
            <div>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-icon">
                    <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
                </svg>
            </div>
        </div>

        <nav>
            <a href="home" class="menu-item">
                <i data-lucide="layout-dashboard" class="menu-icon"></i>
                <span class="text-lg">Inicio</span>
            </a>
            
            <a href="api-key" class="menu-item">
                <i data-lucide="terminal-square" class="menu-icon"></i>
                <span class="text-lg">Mi APi Key</span>
            </a>
            
            <a href="planes.html" class="menu-item">
                <i data-lucide="credit-card" class="menu-icon"></i>
                <span class="text-lg">Recargar / renovar plan</span>
            </a>

            <a href="API-Docs" class="menu-icon"></i>
                <i data-lucide="file-code-2" class="menu-icon"></i>
                <span class="text-lg">Documentación APIs</span>
            </a>

            <a href="PeliPREX" class="menu-item">
                <i data-lucide="clapperboard" class="menu-icon"></i>
                <span class="text-lg">Películas gratis</span>
            </a>
            <a href="consultaPe-vercion-web " class="menu-item active">
                <i data-lucide="globe" class="menu-icon"></i>
                <span class="text-lg">ConsultaPe vercion web</span>
            </a>
        </nav>
        <!-- Redes Sociales en el pie del menú lateral -->
        <div class="social-footer">
            <a href="https://m.facebook.com/61564349657272/" target="_blank"><i class="fab fa-facebook-f"></i></a>
            <a href="https://youtube.com/@eltiojota628?si=sZw2ZHHTUMdaR0nL" target="_blank"><i class="fab fa-youtube"></i></a>
        </div>
    </aside>

    <main class="app-container">
        
        <!-- Selector de consulta: ahora el select está encima del input con los nuevos estilos -->
        <div class="search-group">
            <select class="native-select" id="api-select">
                <option value="">PULSA AQUÍ PARA SELECCIONAR OPCIONES</option>
                <option value="dni">Consulta RENIEC por DNI</option>
                <option value="telefonia-doc">Telefonía por Documento</option>
                <option value="telefonia-num">Telefonía por Número</option>
                <option value="placa">Datos SUNARP Vehículo</option>
                <option value="ruc">SUNAT por RUC</option>
                <option value="empresas">Empresas Relacionadas</option>
                <option value="matrimonios">Matrimonios Registrados</option>
                <option value="buscar-dni">Buscar DNI por Nombres</option>
                <option value="buscar-cedula">Buscar Venezolano por Nombre</option>
                <option value="cedula">Consultar Cédula Venezolana</option>
            </select>
            <input type="text" class="native-input" id="consulta-input" placeholder="☝️ Primero debes seleccionar una opción para consultar" disabled>
        </div>

        <!-- Botón "Consultar" -->
        <div class="mt-2">
            <button class="btn-action" style="background: linear-gradient(135deg, #2563eb, #10b981);" id="consultar-btn">
                CONSULTAR
            </button>
        </div>

        <!-- Loader para consulta -->
        <div id="consulta-loader" class="loader" style="display: none;">
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
        </div>

        <!-- Sección Resultado de consulta -->
        <section class="resultado-wrap" id="resultado-wrap">
            <div class="resultado-header">
                <div class="resultado-header-inner">
                    <div class="resultado-title">
                        <div class="resultado-text">Resultado de consulta</div>
                    </div>
                    <div class="resultado-logo" id="resultado-logo">
                        <div class="logo-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="logo-text">Consulta PE</div>
                    </div>
                </div>
            </div>
            <div class="resultado-body" id="resultado-body"></div>
            <!-- Botón de descarga PDF (rojo, ancho completo) -->
            <button class="btn-pdf-download" id="descargar-pdf-btn" style="display: none;">
                <i class="fas fa-file-pdf"></i> Descargar Resultado en PDF
            </button>
        </section>

        <!-- Sección Perfil y Detalles del Plan (con ajustes en el cuadrado de iniciales y lógica de plan) -->
        <section class="card" id="perfil-plan-section">
            <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Perfil y Detalles del Plan</h2>
            <div id="perfil-plan-contenido">
                <div class="loader" id="perfil-loader">
                    <div class="loader-dot"></div>
                    <div class="loader-dot"></div>
                    <div class="loader-dot"></div>
                </div>
            </div>
        </section>

        <!-- Sección Método de Pago -->
        <section class="card">
            <h2 class="text-sm font-bold text-gray-400 uppercase mb-4">Método de Pago</h2>
            
            <div class="space-y-4">
                <label class="flex items-start gap-4 p-3 border border-gray-100 rounded-xl bg-gray-50 cursor-pointer" id="card-payment-option">
                    <input type="radio" name="pay" checked class="accent-red-600 mt-1">
                    <div class="card-payment-info">
                        <p class="card-payment-text">
                            Tarjeta de Crédito/Débito - Aceptamos tarjetas de crédito y débito
                        </p>
                        <div class="card-icons-container">
                            <i class="fab fa-cc-visa card-icon-item" style="color: #1a1f71;"></i>
                            <i class="fab fa-cc-mastercard card-icon-item" style="color: #eb001b;"></i>
                            <i class="fab fa-cc-amex card-icon-item" style="color: #006fcf;"></i>
                            <span class="card-more-box">y más</span>
                        </div>
                    </div>
                </label>

                <label class="flex items-center gap-4 p-3 border border-gray-100 rounded-xl cursor-pointer" id="whatsapp-payment-option">
                    <input type="radio" name="pay" class="accent-red-600">
                    <div class="flex-1">
                        <p class="text-sm font-bold">Compra por WhatsApp</p>
                        <p class="text-xs text-gray-400">Contacta con nosotros para pagar</p>
                    </div>
                    <div class="text-green-600 font-bold text-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.036 2.5c-5.234 0-9.5 4.266-9.5 9.5 0 1.745.47 3.427 1.35 4.89l-1.386 4.155 4.332-1.336c1.414.8 3.034 1.24 4.704 1.24 5.234 0 9.5-4.266 9.5-9.5s-4.266-9.5-9.5-9.5zm0 17.5c-1.48 0-2.915-.396-4.158-1.138l-.297-.176-3.074.948 1.013-2.99-.162-.312c-.824-1.3-1.26-2.8-1.26-4.332 0-4.44 3.61-8.05 8.05-8.05s8.05 3.61 8.05 8.05-3.61 8.05-8.05 8.05zm4.36-5.99c-.24-.12-1.425-.703-1.646-.783-.22-.08-.38-.12-.54.12s-.62.783-.76.943c-.14.16-.28.18-.52.06-.24-.12-1.014-.374-1.93-1.192-.714-.638-1.196-1.426-1.336-1.667-.14-.24-.015-.37.105-.49.108-.108.24-.282.36-.423.12-.14.16-.24.24-.4.08-.16.04-.3-.02-.42-.06-.12-.54-1.3-.74-1.78-.194-.464-.39-.4-.54-.408h-.46c-.16 0-.42.06-.64.3-.22.24-.84.82-.84 2s.86 2.32.98 2.48c.12.16 1.7 2.6 4.12 3.64.576.248.993.4 1.332.514.56.19 1.07.164 1.473.1.45-.072 1.385-.566 1.58-1.113.195-.547.195-1.016.137-1.114-.058-.098-.213-.158-.453-.278z"></path>
                        </svg>
                    </div>
                </label>
            </div>
        </section>

        <!-- Sección de Tarjeta de Crédito -->
        <section class="card" id="credit-card-section">
            <div class="credit-card-preview mb-6">
                <div class="card-chip absolute top-6 left-6">
                    <div class="chip-dots">
                        <span></span>
                        <span></span>
                    </div>
                </div>
                
                <div class="absolute top-6 right-6 flex gap-1 top-icons">
                    <div class="w-8 h-8 bg-yellow-500 rounded-full"></div>
                    <div class="w-8 h-8 bg-orange-500 rounded-full -ml-4"></div>
                </div>
                <p class="text-xl tracking-widest font-mono mb-2 drop-shadow-lg card-number-display" id="visual-card-number">****** **** **** ******</p>
                <div class="flex justify-between items-end">
                    <span class="text-xs uppercase opacity-90 font-semibold" id="visual-card-holder">TITULAR DE TARJETA</span>
                    <span class="text-xs uppercase opacity-90 font-semibold" id="visual-card-expiry">MM/AA</span>
                </div>
            </div>

            <!-- Selectores de tipo de compra -->
            <div class="flex gap-4 mb-6">
                <div class="flex-1">
                    <label class="text-xs font-bold text-gray-400 block mb-1">Tipo de compra</label>
                    <div class="flex gap-2">
                        <button type="button" class="flex-1 p-2 text-sm font-semibold rounded-lg border-2 transition-all" id="payment-type-credits" style="background: linear-gradient(135deg, #1e40af, #059669); color: white; border-color: transparent;">
                            <i class="fas fa-coins mr-1"></i> Créditos
                        </button>
                        <button type="button" class="flex-1 p-2 text-sm font-semibold rounded-lg border-2 border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" id="payment-type-unlimited">
                            <i class="fas fa-rocket mr-1"></i> Ilimitado
                        </button>
                    </div>
                </div>
            </div>

            <!-- Selector de paquete y precio -->
            <div class="package-selector-container mb-6">
                <div class="select-wrapper">
                    <label class="text-xs font-bold text-gray-400 block mb-1">Selecciona el paquete</label>
                    <select class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm" id="purchase-details-select">
                        <option value="" disabled selected>Selecciona un paquete</option>
                    </select>
                </div>
                <div class="price-wrapper">
                    <label class="text-xs font-bold text-gray-400 block mb-1">Total a pagar</label>
                    <div class="total-price" id="display-amount">S/ 0.00</div>
                </div>
            </div>

            <!-- Formulario de pago -->
            <div id="payment-form-container">
                <form id="form-checkout">
                    <div class="form-group mb-4">
                        <label class="text-xs font-bold text-gray-400 block mb-1">Número de tarjeta</label>
                        <div id="form-checkout__cardNumber" class="mp-container with-icon"></div>
                    </div>

                    <div class="grid-row mb-4">
                        <div class="form-group">
                            <label class="text-xs font-bold text-gray-400 block mb-1">Válido hasta</label>
                            <div id="form-checkout__expirationDate" class="mp-container with-icon-expiry"></div>
                        </div>
                        <div class="form-group">
                            <label class="text-xs font-bold text-gray-400 block mb-1">CVV</label>
                            <div id="form-checkout__securityCode" class="mp-container with-icon-cvv"></div>
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        <label class="text-xs font-bold text-gray-400 block mb-1">Titular de la tarjeta</label>
                        <input 
                            type="text" 
                            id="form-checkout__cardholderName" 
                            class="input-box" 
                            placeholder="Nombre y apellido"
                            required
                        />
                    </div>

                    <div class="form-group mb-4 hidden-field">
                        <label class="text-xs font-bold text-gray-400 block mb-1">Correo electrónico</label>
                        <input 
                            type="email" 
                            id="form-checkout__cardholderEmail" 
                            class="input-box" 
                            placeholder="correo@ejemplo.com"
                            required
                        />
                    </div>

                    <div class="document-container mb-4">
                        <div class="form-group document-type-group">
                            <label class="text-xs font-bold text-gray-400 block mb-1">Tipo de doc.</label>
                            <select id="form-checkout__identificationType" class="input-box" required style="text-align: left; padding-left: 16px;">
                                <option value="">Seleccionar</option>
                            </select>
                        </div>
                        
                        <div class="form-group document-number-group">
                            <label class="text-xs font-bold text-gray-400 block mb-1">Número de documento</label>
                            <input 
                                type="text" 
                                id="form-checkout__identificationNumber" 
                                class="input-box" 
                                placeholder="12345678"
                                required
                                style="text-align: center;"
                            />
                        </div>
                    </div>

                    <div style="display:none">
                        <select id="form-checkout__issuer"></select>
                        <select id="form-checkout__installments"></select>
                    </div>

                    <div class="loading-spinner" id="payment-loading">
                        <div class="spinner"></div>
                        <p class="text-sm text-gray-600">Procesando pago...</p>
                    </div>

                    <button type="submit" id="form-checkout__submit" class="payment-btn" disabled>
                        <i class="fas fa-lock"></i> Proceder al pago
                    </button>

                    <div class="security-badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>Pago 100% seguro y encriptado</span>
                    </div>
                </form>
            </div>

            <div id="payment-error" class="text-red-600 text-sm mt-4 text-center" style="display: none;"></div>
        </section>

        <!-- ===== NUEVA SECCIÓN DE PREGUNTAS FRECUENTES (FAQ) ===== -->
        <!-- Esta sección se coloca exactamente antes de "Nuestros Servicios" -->
        <section class="card">
            <h2 class="text-sm font-bold text-gray-400 uppercase mb-4">Preguntas Frecuentes (FAQ)</h2>
            <div class="space-y-2" id="faq-container">
                <!-- FAQ 1 -->
                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">
                        <span>¿Qué tipos de planes ofrecemos?</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            <p>Pensando en lo que realmente necesitas, te ofrecemos 2 opciones para que elijas la que mejor se adapte a tu uso:</p>
                            <p><strong>A.) Plan ilimitado (Recomendado ⭐):</strong><br>
                            Acceso total sin límites durante los días que elijas.<br>
                            Ideal si usas la plataforma con frecuencia y quieres olvidarte de contar créditos.</p>
                            <p><strong>B.) Créditos:</strong><br>
                            Pagas solo por lo que usas.<br>
                            No tienen fecha de vencimiento, se consumen poco a poco según el uso que le des.</p>
                            <p>👉 Si usas el servicio constantemente, el plan ilimitado suele ser más conveniente.</p>
                        </div>
                    </div>
                </div>
                <!-- FAQ 2 -->
                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">
                        <span>¿Qué métodos de pago están disponibles?</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            <p>Hemos simplificado el proceso para que puedas comprar rápido y seguro:</p>
                            <p><strong>A.) Pago con tarjeta (Automático ⚡):</strong><br>
                            Aceptamos Visa, MasterCard y más.<br>
                            Solo completas tus datos y confirmas la compra.<br>
                            Si el pago es aprobado, tus créditos o plan se activan automáticamente en segundos.</p>
                            <p><strong>B.) Pago por WhatsApp:</strong><br>
                            También puedes comprar con ayuda personalizada.<br>
                            Un asesor te guiará en todo el proceso.<br>
                            La activación puede tardar un poco, ya que depende de la atención manual.</p>
                            <p>👉 Si quieres activación inmediata, te recomendamos pagar con tarjeta.</p>
                        </div>
                    </div>
                </div>
                <!-- FAQ 3 -->
                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">
                        <span>¿Se cobran comisiones?</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            <p>Queremos ser claros contigo:</p>
                            <p><strong>A.) Compras desde la web:</strong><br>
                            No cobramos comisiones adicionales, el precio que ves es el final.<br>
                            En caso de reembolso, se descuenta únicamente la comisión de la pasarela de pago y el consumo realizado.</p>
                            <p><strong>B.) Compras por WhatsApp:</strong><br>
                            No cobramos comisiones ni en la compra ni en reembolsos.</p>
                            <p>👉 Siempre sabrás exactamente lo que estás pagando, sin costos ocultos.</p>
                        </div>
                    </div>
                </div>
                <!-- FAQ 4 -->
                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">
                        <span>¿Hay horarios para comprar?</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            <p><strong>A.) Desde la web:</strong><br>
                            Puedes comprar en cualquier momento, 24/7, sin restricciones.</p>
                            <p><strong>B.) Por WhatsApp:</strong><br>
                            Horario de atención de 6:00 a.m. a 9:00 p.m.<br>
                            Fuera de ese horario, algunos métodos de pago pueden no estar disponibles.</p>
                            <p>👉 Para comprar sin esperar, lo mejor es hacerlo directamente desde la web.</p>
                        </div>
                    </div>
                </div>
                <!-- FAQ 5 -->
                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">
                        <span>¿Dónde puedo usar mis créditos o plan?</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            <p>Todo está conectado en una sola plataforma.</p>
                            <p>Tus créditos o plan funcionan en:</p>
                            <ul>
                                <li>APIs</li>
                                <li>Películas (PeliPREX HD)</li>
                                <li>Consulta PE</li>
                                <li>Otros servicios disponibles</li>
                            </ul>
                            <p>👉 No necesitas comprar por separado, todo se integra en tu cuenta.</p>
                        </div>
                    </div>
                </div>
                <!-- FAQ 6 -->
                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">
                        <span>¿El soporte es 24/7?</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            <p>Sí, puedes escribirnos en cualquier momento del día, los 365 días del año.</p>
                            <p>Atendemos tanto por la web como por WhatsApp.</p>
                            <p>Si en algún momento tardamos en responder, te pedimos un poco de paciencia, ya que podemos estar atendiendo a otros usuarios.</p>
                            <p>👉 Siempre tendrás a alguien para ayudarte.</p>
                        </div>
                    </div>
                </div>
                <!-- FAQ 7 -->
                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">
                        <span>¿Cuánto cuestan los planes?</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            <p>Tenemos opciones para todos:</p>
                            <ul>
                                <li>Planes ilimitados desde 60 soles</li>
                                <li>Créditos desde 10 soles</li>
                            </ul>
                            <p>Puedes ver la tabla completa, comparar y elegir lo que más te convenga en la sección de planes.</p>
                            <p>👉 Si usas el sistema con frecuencia, el plan ilimitado suele ser la mejor inversión.</p>
                        </div>
                    </div>
                </div>
                <!-- FAQ 8 -->
                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">
                        <span>¿Puedo comprar para otra persona?</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            <p>Sí, puedes hacerlo fácilmente.</p>
                            <p>Si deseas recargar tu propia cuenta, solo realiza la compra normalmente.</p>
                            <p>Si quieres recargar a otra persona (amigo, familiar, etc.), solo debes ingresar sus datos (correo o ID) antes de completar el pago.</p>
                            <p>👉 Una vez confirmado el pago, los créditos o plan se activan directamente en la cuenta indicada.</p>
                        </div>
                    </div>
                </div>
                <!-- FAQ 9 -->
                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">
                        <span>¿Es segura esta web?</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            <p>Sí, la seguridad es una prioridad para nosotros.</p>
                            <p>Contamos con sistemas de protección avanzados para cuidar tu información y evitar accesos no autorizados.</p>
                            <p>Además, realizamos pruebas constantes para mantener la plataforma protegida.</p>
                            <p>👉 Aun así, te recomendamos usar una contraseña segura para mayor protección.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- ===== FIN DE NUEVA SECCIÓN FAQ ===== -->

        <!-- Slider de servicios -->
        <section class="card">
            <h2 class="text-sm font-bold text-gray-400 uppercase mb-4">Nuestros Servicios</h2>
            
            <div class="services-slider">
                <a href="PeliPREX.html" class="service-card" style="text-decoration: none;">
                    <div class="service-image service-img-1"></div>
                    <div class="service-text">peliPREX HD – Películas online gratis</div>
                </a>
                
                <a href="historial.html" class="service-card" style="text-decoration: none;">
                    <div class="service-image service-img-2"></div>
                    <div class="service-text">Historial de películas que vi</div>
                </a>
                
                <a href="aPI-Docs" class="service-card" style="text-decoration: none;">
                    <div class="service-image service-img-3"></div>
                    <div class="service-text">Colección de apis</div>
                </a>
                
                <a href="https://com-masitaorex.uptodown.com/android" target="_blank" class="service-card" style="text-decoration: none;">
                    <div class="service-image service-img-4"></div>
                    <div class="service-text">Aplicación consulta pe apk</div>
                </a>

                <a href="https://youtube.com/@eltiojota628?si=PEutWDR4W1hhycwQ" target="_blank" class="service-card" style="text-decoration: none;">
                    <div class="service-image service-img-5"></div>
                    <div class="service-text">Sigue nuestro canal en Youtube @el tío jota</div>
                </a>
            </div>
        </section>

        <!-- Sección Aplicación Consulta PE -->
        <section class="card">
            <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Aplicación Consulta PE</h2>
            
            <div class="flex items-center gap-4 mb-4">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-800 rounded-2xl flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                    <img src="https://www.appcreator24.com/srv/imgs/gen/2706889_ico.png?ts=1771379922" alt="App Icon" class="w-12 h-12 object-contain">
                </div>
                <div>
                    <h3 class="font-bold text-xl">Consulta PE</h3>
                    <p class="text-xs text-gray-400 font-medium">Desarrollado por Masitaprex</p>
                </div>
            </div>

            <p class="text-sm text-gray-600 mb-3">
                Plataforma de infraestructura tecnológica para consultas de entidades públicas de Perú y Venezuela.
            </p>

            <div class="flex gap-2 overflow-x-auto mb-4 py-2" id="screenshots-container">
                <div class="w-20 h-20 bg-gray-200 rounded-xl flex-shrink-0 overflow-hidden cursor-pointer screenshot-img" onclick="openImageViewer(0)">
                    <img src="https://img.utdstc.com/screen/9e0/c70/9e0c7077ae3bfc5941fd1dafa9c85999cca88917d27fea87a7fe9436b0a4ac09:800" class="w-full h-full object-cover">
                </div>
                <div class="w-20 h-20 bg-gray-200 rounded-xl flex-shrink-0 overflow-hidden cursor-pointer screenshot-img" onclick="openImageViewer(1)">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj8yMQqAdkkhsN2cICUm9NCzx1q5g8xTcXa2HqpVzrTOk_y-o8jzCfvkFuSvmztsQjG61fBSFpzruFpuMH_tA3K1xhSFZnIlHhHlw5JUjlHCjTXMuvKnFzHlVuuNEB4pCWb2l_fXMmetGPtxxmzm0cjgCtMVHE0z4s0DLnE3uVPiF_21TLZMQtDG1b5fj4/s1920/1000112201.png" class="w-full h-full object-cover">
                </div>
                <div class="w-20 h-20 bg-gray-200 rounded-xl flex-shrink-0 overflow-hidden cursor-pointer screenshot-img" onclick="openImageViewer(2)">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgAiCpWnAh6FkIP4UwyXXobfAhL6s_CkMoMI7rH_BD9_v7JmR3pmUjw5b5JNaJQpBrt0AecRTGGTlSXHZDb51JYfVoVrRUmZLm97voHDySY4RRQok0Zx9zGGHeJbMc6o9tv0yofjB9dXh2mrpf9fQ7_96QYQkzxO73vTKS01ATOpguR6b102_lvJcN8ELc/s1920/1000112195.png" class="w-full h-full object-cover">
                </div>
                <div class="w-20 h-20 bg-gray-200 rounded-xl flex-shrink-0 overflow-hidden cursor-pointer screenshot-img" onclick="openImageViewer(3)">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhI6dLVE8LK6Kctnz_N9H-LoygwIz7VdH_acnbNQECLE6D5Chch17gG8fhL-d9NQaFiMSZhQNGwZHlv_fVsLcmw2Gvb67dvqO7gI5uOzuqO25pOGUTYz7c9ztnoJFZ4ig_gRJkXeIDxTxAW4nYzloirffv4Fdf1XuiOSnD4vxj6qIAj5Iv0rquHWdsEOtE/s1920/1000112205.png" class="w-full h-full object-cover">
                </div>
            </div>

            <p class="text-sm text-gray-700 leading-relaxed mb-5">
                La plataforma Consulta PE (versión web y aplicación APK propiedad de Masitaprex) es una solución de infraestructura tecnológica que facilita el acceso a información de fuentes públicas de Perú y Venezuela. Obtén información de RENIEC, SUNAT, SUNARP, búsqueda de personas venezolanas por cédula o nombre, y mucho más. Todo en un solo lugar, con una interfaz rápida y fácil de usar. 
                <a href="https://com-masitaorex.uptodown.com/android" target="_blank" class="text-blue-600 hover:underline font-semibold">Leer más</a>
            </p>

            <button class="w-full bg-gradient-to-r from-red-600 to-red-500 text-white font-bold py-4 px-4 rounded-xl shadow-md active:scale-[0.98] transition-all flex items-center justify-center gap-2" onclick="window.open('https://apk.e-droid.net/apk/app2706889-uk81cm.apk?v=80', '_blank')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" ></path>
                </svg>
                INSTALAR APLICACIÓN
            </button>
        </section>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Infraestructura tecnológica Consulta PE - Intermediario Tecnológico</h3>
                <p>Operado por <strong>CUBAS PEREZ JOSE RENE (RUC 10736224351)</strong>. Brindamos servicios de interconectividad técnica para acceso a información pública.</p>
                <p>Los créditos cubren exclusivamente costos de infraestructura, procesamiento de datos y mantenimiento técnico.</p>
                <div class="social-icons">
                    <a href="https://m.facebook.com/61564349657272/" target="_blank" aria-label="Facebook">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="https://youtube.com/@eltiojota628?si=sZw2ZHHTUMdaR0nL" target="_blank" aria-label="YouTube">
                        <i class="fab fa-youtube"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Modal para vista ampliada de imágenes -->
    <div class="image-modal" id="imageModal">
        <div class="image-modal-content">
            <span class="image-modal-close" onclick="closeImageViewer()">×</span>
            <span class="image-modal-prev" id="modalPrev" onclick="changeImage(-1)">❮</span>
            <span class="image-modal-next" id="modalNext" onclick="changeImage(1)">❯</span>
            <img class="image-modal-img" id="modalImage" src="" alt="Imagen ampliada">
        </div>
    </div>

    <script>
    /* ==========================================================
       FUNCIÓN PARA EL ACORDEÓN DE PREGUNTAS FRECUENTES
       ========================================================= */
    function toggleFaq(button) {
        // Encuentra el contenedor de la respuesta (el hermano siguiente al botón)
        const answerDiv = button.nextElementSibling;
        const icon = button.querySelector('i');

        // Si la respuesta está expandida, la contraemos; si no, la expandimos
        if (answerDiv.style.maxHeight && answerDiv.style.maxHeight !== '0px') {
            // Contraer
            answerDiv.style.maxHeight = '0';
            if (icon) {
                icon.style.transform = 'rotate(0deg)';
            }
        } else {
            // Expandir
            answerDiv.style.maxHeight = answerDiv.scrollHeight + 'px';
            if (icon) {
                icon.style.transform = 'rotate(180deg)';
            }
        }
    }

    // Asegurar que todas las respuestas comiencen cerradas
    document.addEventListener('DOMContentLoaded', function() {
        const answers = document.querySelectorAll('.faq-answer');
        answers.forEach(answer => {
            answer.style.maxHeight = '0';
        });

        // También aseguramos que los iconos tengan la rotación correcta
        const icons = document.querySelectorAll('.faq-question i');
        icons.forEach(icon => {
            icon.style.transform = 'rotate(0deg)';
            icon.style.transition = 'transform 0.3s ease';
        });
    });

    /* ==========================================================
       CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE (todo igual)
       ========================================================= */
    const firebaseConfig = {
      apiKey: "AIzaSyAvzBfVUN_xRw-fuBEZdhoTasTMws1yERg",
      authDomain: "consulta-pe-abf99.firebaseapp.com",
      projectId: "consulta-pe-abf99",
      storageBucket: "consulta-pe-abf99.firebasestorage.app",
      messagingSenderId: "610275972424",
      appId: "1:610275972424:android:19d11c9ed5fdce6dc64f7d"
    };

    if(firebase.apps.length === 0){
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const FieldValue = firebase.firestore.FieldValue;

    let USER_EMAIL = null;
    let USER_UID = null;
    let USER_API_KEY = null;

    const perfilContenido = document.getElementById('perfil-plan-contenido');
    const perfilLoader = document.getElementById('perfil-loader');
    const consultaLoader = document.getElementById('consulta-loader');

    function generarApiKey() {
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
    }

    function formatDate(isoDate) {
        if (!isoDate) return 'N/A';
        try {
            if (typeof isoDate === 'object' && isoDate.toDate) {
                isoDate = isoDate.toDate();
            }
            const date = new Date(isoDate);
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
        } catch (e) {
            return 'N/A';
        }
    }

    function renderizarPerfilConDatos(userData) {
        if (!perfilContenido) return;

        if (!userData) {
            perfilContenido.innerHTML = `
                <div class="text-center py-8 text-red-600">
                    <p class="font-semibold">Error al cargar el perfil</p>
                    <p class="text-sm mt-2">No se pudieron obtener los datos del usuario.</p>
                </div>
            `;
            return;
        }

        USER_API_KEY = userData.apiKey;

        const nombre = userData.email ? userData.email.split('@')[0] : 'Usuario';
        const email = userData.email || 'correo@ejemplo.com';
        const iniciales = nombre.substring(0, 2).toUpperCase() || 'U';
        
        const tipoPlan = userData.tipoPlan || 'creditos';
        const creditos = userData.creditos || 0;
        
        let apiKey = userData.apiKey;
        if (!apiKey) {
            apiKey = generarApiKey();
        }
        
        let fechaActivacion = 'No disponible';
        if (userData.fechaActivacion) {
            fechaActivacion = formatDate(userData.fechaActivacion);
        }
        
        let planIlimitadoHasta = 'No aplica';
        let duracionDias = 'No aplica';
        let diasRestantes = 'No aplica';
        let fechaVencimiento = 'No aplica';
        
        // Variables para los nuevos cálculos
        let diasTranscurridos = 0;
        let diasRestantesCalculado = 'No aplica';
        
        if (tipoPlan === 'ilimitado') {
            // Calcular días restantes reales basados en fecha de activación y duración
            if (userData.fechaActivacion && userData.duracionDias) {
                try {
                    let activacion;
                    if (typeof userData.fechaActivacion === 'object' && userData.fechaActivacion.toDate) {
                        activacion = userData.fechaActivacion.toDate();
                    } else {
                        activacion = new Date(userData.fechaActivacion);
                    }
                    
                    const hoy = new Date();
                    const tiempoTranscurrido = hoy - activacion;
                    diasTranscurridos = Math.floor(tiempoTranscurrido / (1000 * 60 * 60 * 24));
                    
                    const duracionTotal = parseInt(userData.duracionDias);
                    const diasRestantesNum = duracionTotal - diasTranscurridos;
                    
                    diasRestantesCalculado = diasRestantesNum > 0 ? `${diasRestantesNum} días` : 'Expirado';
                } catch (e) {
                    console.error("Error calculando días restantes reales:", e);
                    diasRestantesCalculado = 'Error en cálculo';
                }
            } else {
                diasRestantesCalculado = 'No disponible';
            }
            
            if (userData.fechaVencimiento) {
                fechaVencimiento = formatDate(userData.fechaVencimiento);
                planIlimitadoHasta = fechaVencimiento;
            }
            
            if (userData.duracionDias) {
                duracionDias = userData.duracionDias;
            }
        }

        const ultimaCompra = userData.ultimaCompra ? formatDate(userData.ultimaCompra) : 'No disponible';
        const ultimaConsulta = userData.ultimaConsulta ? formatDate(userData.ultimaConsulta) : 'No disponible';
        const totalConsultas = userData.totalConsultas || 0;

        // Construir la tabla según el tipo de plan
        let tablaHtml = '';
        
        if (tipoPlan === 'ilimitado') {
            // Para plan ilimitado: no mostrar total consultas y ocultar "Válido hasta" visualmente
            tablaHtml = `
                <table class="plan-detail-table">
                    <tr>
                        <td>Tipo de Plan</td>
                        <td>Ilimitado</td>
                    </tr>
                    <tr>
                        <td>Duración (días)</td>
                        <td>${duracionDias}</td>
                    </tr>
                    <tr>
                        <td>Días restantes</td>
                        <td>${diasRestantesCalculado}</td>
                    </tr>
                    <tr>
                        <td>Fecha de Activación</td>
                        <td>${fechaActivacion}</td>
                    </tr>
                    <tr class="hidden"> <!-- Fila oculta visualmente -->
                        <td>Válido hasta</td>
                        <td>${planIlimitadoHasta}</td>
                    </tr>
                    <tr>
                        <td>Última consulta</td>
                        <td>${ultimaConsulta}</td>
                    </tr>
                    <!-- Fila de Total consultas eliminada completamente -->
                </table>
            `;
        } else {
            // Para plan de créditos: todo se mantiene exactamente igual
            tablaHtml = `
                <table class="plan-detail-table">
                    <tr>
                        <td>Tipo de Plan</td>
                        <td>Créditos</td>
                    </tr>
                    <tr>
                        <td>Créditos disponibles</td>
                        <td>${creditos}</td>
                    </tr>
                    <tr>
                        <td>Fecha de Activación</td>
                        <td>${fechaActivacion}</td>
                    </tr>
                    <tr>
                        <td>Última consulta</td>
                        <td>${ultimaConsulta}</td>
                    </tr>
                    <tr>
                        <td>Válido hasta</td>
                        <td>No vence</td>
                    </tr>
                </table>
            `;
        }

        // API Key oculta - se muestra como asteriscos en lugar del valor real
        const apiKeyOculta = '••••••••••••••••••••••••';

        perfilContenido.innerHTML = `
            <div class="flex items-center gap-4 mb-6 pb-4 border-b border-gray-100">
                <!-- Cuadrado de iniciales: ancho y alto iguales (60px) y centrado -->
                <div class="w-[60px] h-[60px] bg-gradient-to-br from-red-500 to-red-700 rounded-2xl flex items-center justify-center text-white text-2xl font-bold flex-shrink-0">
                    ${iniciales}
                </div>
                <div>
                    <h3 class="font-bold text-lg">${nombre}</h3>
                    <p class="text-sm text-gray-500">${email}</p>
                    <p class="text-xs text-gray-400 mt-1 break-all"><span class="font-mono">${apiKeyOculta}</span></p>
                </div>
            </div>

            ${tablaHtml}
        `;

        if (!userData.apiKey && userData.email) {
            const userRef = db.collection("usuarios").doc(auth.currentUser.uid);
            userRef.update({
                apiKey: apiKey
            }).catch(error => {
                console.error("Error guardando API Key:", error);
            });
        }
    }

    async function cargarDatosPerfil() {
        const user = auth.currentUser;
        
        if (!user) {
            perfilContenido.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p class="font-semibold">No has iniciado sesión</p>
                    <p class="text-sm mt-2">Inicia sesión para ver los detalles de tu perfil y plan.</p>
                </div>
            `;
            if (perfilLoader) perfilLoader.style.display = 'none';
            return;
        }

        USER_EMAIL = user.email;
        USER_UID = user.uid;

        try {
            if (perfilLoader) perfilLoader.style.display = 'flex';
            
            const userRef = db.collection("usuarios").doc(user.uid);
            const doc = await userRef.get();
            
            if (doc.exists) {
                const userData = doc.data();
                renderizarPerfilConDatos(userData);
            } else {
                console.warn("Documento de usuario no encontrado en Firestore.");
                const defaultUserData = {
                    email: user.email,
                    tipoPlan: "creditos",
                    creditos: 5,
                    fechaActivacion: FieldValue.serverTimestamp(),
                    duracionDias: 0,
                    apiKey: generarApiKey(),
                    ultimaCompra: null,
                    ultimaConsulta: null
                };
                await userRef.set(defaultUserData);
                console.log("Documento de usuario por defecto creado con 5 créditos y API Key.");
                renderizarPerfilConDatos(defaultUserData);
            }
            
            if (perfilLoader) perfilLoader.style.display = 'none';
            
        } catch (error) {
            console.error("Error al cargar los datos del usuario:", error);
            perfilContenido.innerHTML = `
                <div class="text-center py-8 text-red-600">
                    <p class="font-semibold">Error al cargar el perfil</p>
                    <p class="text-sm mt-2">${error.message || 'Intenta de nuevo más tarde.'}</p>
                    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-xl text-sm">
                        Reintentar
                    </button>
                </div>
            `;
            if (perfilLoader) perfilLoader.style.display = 'none';
        }
    }

    auth.onAuthStateChanged((user) => {
        if (user) {
            USER_EMAIL = user.email;
            USER_UID = user.uid;
            cargarDatosPerfil();
        } else {
            if (perfilContenido) {
                perfilContenido.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="font-semibold">No has iniciado sesión</p>
                        <p class="text-sm mt-2">Inicia sesión para ver los detalles de tu perfil y plan.</p>
                        <a href="login.html" class="mt-4 inline-block px-4 py-2 bg-red-600 text-white rounded-xl text-sm">
                            Iniciar sesión
                        </a>
                    </div>
                `;
            }
            if (perfilLoader) perfilLoader.style.display = 'none';
        }
    });

    /* ==========================================================
       FUNCIONALIDAD DE CONSULTA A LA API (todo igual)
       ========================================================= */
    const apiSelect = document.getElementById('api-select');
    const consultaInput = document.getElementById('consulta-input');
    const consultarBtn = document.getElementById('consultar-btn');
    const resultadoBody = document.getElementById('resultado-body');
    const resultadoLogo = document.getElementById('resultado-logo');
    const resultadoWrap = document.getElementById('resultado-wrap');
    const descargarPdfBtn = document.getElementById('descargar-pdf-btn');

    let ultimoResultadoConsulta = null;
    let tipoConsultaActual = null;

    const placeholders = {
        'dni': 'Ej: 12345678',
        'telefonia-doc': 'Ej: 12345678 o 20123456789',
        'telefonia-num': 'Ej: 987654321',
        'placa': 'Ej: ABC-123',
        'ruc': 'Ej: 20123456789',
        'empresas': 'Ej: 12345678',
        'matrimonios': 'Ej: 12345678',
        'buscar-dni': 'Ej: Juan Carlos Perez Gomez',
        'buscar-cedula': 'Ej: Maria Rodriguez',
        'cedula': 'Ej: V12345678'
    };

    const endpoints = {
        'dni': 'consulta/dni',
        'telefonia-doc': 'consulta/telefonia-doc',
        'telefonia-num': 'consulta/telefonia-num',
        'placa': 'consulta/placa',
        'ruc': 'consulta/ruc',
        'empresas': 'consulta/empresas',
        'matrimonios': 'consulta/matrimonios',
        'buscar-dni': 'consulta/buscar-dni',
        'buscar-cedula': 'consulta/buscar-cedula',
        'cedula': 'consulta/cedula'
    };

    const paramNames = {
        'dni': 'dni',
        'telefonia-doc': 'documento',
        'telefonia-num': 'numero',
        'placa': 'placa',
        'ruc': 'data',
        'empresas': 'dni',
        'matrimonios': 'dni',
        'buscar-dni': null,
        'buscar-cedula': 'query',
        'cedula': 'cedula'
    };

    // Opciones que requieren solo números (para activar teclado numérico)
    const numericOptions = ['dni', 'telefonia-doc', 'telefonia-num', 'ruc', 'empresas', 'matrimonios', 'cedula'];

    const nombresCamposDni = {
        'nuDni': 'DNI',
        'apCasada': 'Apellido de casada',
        'apePaterno': 'Apellido paterno',
        'apeMaterno': 'Apellido materno',
        'preNombres': 'Nombres',
        'nuFicha': 'N° Ficha',
        'nuImagen': 'N° Imagen',
        'feNacimiento': 'Fecha de nacimiento',
        'estatura': 'Estatura',
        'sexo': 'Sexo',
        'estadoCivil': 'Estado civil',
        'gradoInstruccion': 'Grado de instrucción',
        'feEmision': 'Fecha de emisión',
        'feInscripcion': 'Fecha de inscripción',
        'nomPadre': 'Nombre del padre',
        'nomMadre': 'Nombre de la madre',
        'pais': 'País',
        'departamento': 'Departamento',
        'provincia': 'Provincia',
        'distrito': 'Distrito',
        'pad': 'PAD',
        'depaDireccion': 'Departamento (dirección)',
        'provDireccion': 'Provincia (dirección)',
        'distDireccion': 'Distrito (dirección)',
        'feCaducidad': 'Fecha de caducidad',
        'donaOrganos': 'Donante de órganos',
        'observacion': 'Observación',
        'feRestriccion': 'Fecha de restricción',
        'deRestriccion': 'Descripción de restricción',
        'desDireccion': 'Dirección',
        'gpVotacion': 'Grupo de votación',
        'telefono': 'Teléfono',
        'email': 'Email',
        'multasElectorales': 'Multas electorales',
        'multaAdmin': 'Multa administrativa',
        'feActualizacion': 'Fecha de actualización',
        'docSustento': 'Documento de sustento',
        'nuDocSustento': 'N° documento de sustento',
        'nuDocDeclarante': 'N° documento del declarante',
        'vinculoDeclarante': 'Vínculo del declarante',
        'tipoDeclarante': 'Tipo de declarante',
        'coTipoDocPadre': 'Tipo documento del padre',
        'coTipoDocMadre': 'Tipo documento de la madre',
        'nuDocPadre': 'N° documento del padre',
        'nuDocMadre': 'N° documento de la madre',
        'feFallecimiento': 'Fecha de fallecimiento',
        'cancelacion': 'Cancelación',
        'nomDeclarante': 'Nombre del declarante',
        'digitoVerificacion': 'Dígito de verificación'
    };

    function crearTablasDesdeObjeto(obj, nivel = 0, esDni = false) {
        if (!obj || typeof obj !== 'object') return '';
        
        let html = '';
        
        if (Array.isArray(obj)) {
            if (obj.length === 0) return '<p class="text-gray-500 text-center py-4">No hay datos para mostrar</p>';
            
            obj.forEach((item, index) => {
                if (typeof item === 'object') {
                    html += `<div class="resultado-section-title">Elemento ${index + 1}</div>`;
                    html += crearTablasDesdeObjeto(item, nivel + 1, esDni);
                }
            });
            return html;
        }
        
        const entries = Object.entries(obj);
        if (entries.length === 0) return '';
        
        const hasNestedObjects = entries.some(([_, value]) => value && typeof value === 'object');
        
        if (hasNestedObjects && nivel === 0) {
            if (esDni && obj.imagenes) {
                html += `<div class="resultado-section-title">IMÁGENES BIOMÉTRICAS</div>`;
                html += `<table class="resultado-table">`;
                
                if (obj.imagenes.huella_izquierda) {
                    html += `
                        <tr>
                            <td class="font-semibold">Huella izquierda</td>
                            <td><img src="data:image/jpeg;base64,${obj.imagenes.huella_izquierda}" class="huella-img" style="max-width: 200px;"></td>
                        </tr>
                    `;
                }
                if (obj.imagenes.huella_derecha) {
                    html += `
                        <tr>
                            <td class="font-semibold">Huella derecha</td>
                            <td><img src="data:image/jpeg;base64,${obj.imagenes.huella_derecha}" class="huella-img" style="max-width: 200px;"></td>
                        </tr>
                    `;
                }
                if (obj.imagenes.firma) {
                    html += `
                        <tr>
                            <td class="font-semibold">Firma</td>
                            <td><img src="data:image/jpeg;base64,${obj.imagenes.firma}" class="firma-img" style="max-width: 200px;"></td>
                        </tr>
                    `;
                }
                html += `</table>`;
                
                if (obj.imagenes.foto) {
                    resultadoLogo.innerHTML = `<img src="data:image/jpeg;base64,${obj.imagenes.foto}" class="foto-carnet">`;
                }
            }
            
            entries.forEach(([key, value]) => {
                if (value && typeof value === 'object' && key !== 'imagenes') {
                    html += `<div class="resultado-section-title">${key.replace(/_/g, ' ').toUpperCase()}</div>`;
                    html += crearTablasDesdeObjeto(value, nivel + 1, false);
                }
            });
            
            const simpleProps = entries.filter(([_, value]) => !(value && typeof value === 'object'));
            if (simpleProps.length > 0) {
                html += `<div class="resultado-section-title">DATOS PERSONALES</div>`;
                html += `<table class="resultado-table">`;
                simpleProps.forEach(([key, value]) => {
                    const displayValue = value !== null && value !== undefined ? value : 'N/A';
                    const nombreCampo = nombresCamposDni[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    html += `
                        <tr>
                            <td class="font-semibold" style="width: 40%;">${nombreCampo}</td>
                            <td style="word-break: break-word;">${displayValue}</td>
                        </tr>
                    `;
                });
                html += `</table>`;
            }
        } else {
            html += `<table class="resultado-table">`;
            entries.forEach(([key, value]) => {
                if (value && typeof value === 'object') {
                    html += `
                        <tr>
                            <td class="font-semibold" colspan="2">${key.replace(/_/g, ' ').toUpperCase()}</td>
                        </tr>
                        <tr>
                            <td colspan="2" style="padding: 0;">
                                ${crearTablasDesdeObjeto(value, nivel + 1, false)}
                            </td>
                        </tr>
                    `;
                } else {
                    const displayValue = value !== null && value !== undefined ? value : 'N/A';
                    html += `
                        <tr>
                            <td class="font-semibold" style="width: 40%;">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                            <td style="word-break: break-word;">${displayValue}</td>
                        </tr>
                    `;
                }
            });
            html += `</table>`;
        }
        
        return html;
    }

    apiSelect.addEventListener('change', function() {
        const selected = this.value;
        if (selected) {
            consultaInput.disabled = false;
            consultaInput.placeholder = placeholders[selected] || 'Escribe tu consulta aquí...';
            
            // Activar teclado numérico solo si la opción requiere números (excluyendo 'placa')
            if (numericOptions.includes(selected)) {
                consultaInput.type = 'number';
                consultaInput.inputMode = 'numeric';
                consultaInput.pattern = '[0-9]*';
            } else {
                consultaInput.type = 'text';
                consultaInput.inputMode = 'text';
                consultaInput.removeAttribute('pattern');
            }
        } else {
            consultaInput.disabled = true;
            consultaInput.placeholder = 'Primero debes seleccionar una opción para poder consultar';
            consultaInput.type = 'text';
            consultaInput.inputMode = 'text';
            consultaInput.removeAttribute('pattern');
        }
        
        if (selected === 'buscar-dni') {
            consultaInput.placeholder = 'Formato: Nombres ApellidoPaterno ApellidoMaterno';
        }
        
        resultadoLogo.innerHTML = `
            <div class="logo-icon">
                <i class="fas fa-database"></i>
            </div>
            <div class="logo-text">Consulta PE</div>
        `;
    });

    async function realizarConsulta() {
        const selectedApi = apiSelect.value;
        const consultaValue = consultaInput.value.trim();
        
        if (!selectedApi) {
            alert('Por favor, selecciona un servicio.');
            return;
        }
        
        if (!consultaValue) {
            alert('Por favor, ingresa un valor para la consulta.');
            return;
        }
        
        const user = auth.currentUser;
        if (!user) {
            alert('Debes iniciar sesión para realizar consultas.');
            return;
        }
        
        let apiKey = USER_API_KEY;
        
        if (!apiKey) {
            try {
                const userRef = db.collection("usuarios").doc(user.uid);
                const doc = await userRef.get();
                if (doc.exists) {
                    apiKey = doc.data().apiKey;
                    USER_API_KEY = apiKey;
                }
            } catch (error) {
                console.error('Error obteniendo API Key:', error);
                alert('Error al obtener tu API Key. Intenta de nuevo.');
                return;
            }
        }
        
        if (!apiKey) {
            alert('No se encontró un API Key para tu cuenta. Por favor, recarga la página.');
            return;
        }
        
        let requestData = {};
        const paramName = paramNames[selectedApi];
        
        if (selectedApi === 'buscar-dni') {
            const parts = consultaValue.split(' ');
            if (parts.length < 2) {
                alert('Formato incorrecto. Usa: Nombres ApellidoPaterno ApellidoMaterno');
                return;
            }
            requestData = {
                nombres: parts[0],
                apepaterno: parts[1],
                apematerno: parts.slice(2).join(' ') || ''
            };
        } else if (paramName) {
            requestData[paramName] = consultaValue;
        } else {
            requestData = consultaValue;
        }
        
        const baseUrl = 'https://api.masitaprex.com/v3';
        const endpoint = endpoints[selectedApi];
        const url = `${baseUrl}/${endpoint}`;
        
        try {
            consultarBtn.textContent = 'CONSULTANDO...';
            consultarBtn.disabled = true;
            consultaLoader.style.display = 'flex';
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey
                },
                body: JSON.stringify(requestData)
            });
            
            const result = await response.json();
            console.log('Resultado de la consulta:', result);
            
            resultadoLogo.innerHTML = `
                <div class="logo-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="logo-text">Consulta PE</div>
            `;
            
            consultaLoader.style.display = 'none';
            
            if (result.success && result.data) {
                const esDni = selectedApi === 'dni' && result.data.result;
                if (esDni) {
                    ultimoResultadoConsulta = result.data.result;
                    tipoConsultaActual = selectedApi;
                    resultadoBody.innerHTML = crearTablasDesdeObjeto(result.data.result, 0, true);
                } else {
                    ultimoResultadoConsulta = result.data;
                    tipoConsultaActual = selectedApi;
                    resultadoBody.innerHTML = crearTablasDesdeObjeto(result.data);
                }
                resultadoWrap.style.display = 'block';
                descargarPdfBtn.style.display = 'flex';
            } else if (result.error) {
                ultimoResultadoConsulta = { error: result.error };
                tipoConsultaActual = selectedApi;
                resultadoBody.innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <p class="font-semibold">Error en la consulta</p>
                        <p class="text-sm mt-2">${result.error}</p>
                    </div>
                `;
                resultadoWrap.style.display = 'block';
                descargarPdfBtn.style.display = 'flex';
            } else {
                ultimoResultadoConsulta = { mensaje: 'Sin resultados' };
                tipoConsultaActual = selectedApi;
                resultadoBody.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="font-semibold">Sin resultados</p>
                        <p class="text-sm mt-2">No se encontraron datos para la consulta realizada.</p>
                    </div>
                `;
                resultadoWrap.style.display = 'block';
                descargarPdfBtn.style.display = 'flex';
            }
            
        } catch (error) {
            console.error('Error al realizar la consulta:', error);
            ultimoResultadoConsulta = { error: 'Error de conexión' };
            tipoConsultaActual = selectedApi;
            resultadoBody.innerHTML = `
                <div class="text-center py-8 text-red-600">
                    <p class="font-semibold">Error de conexión</p>
                    <p class="text-sm mt-2">No se pudo completar la consulta. Intenta de nuevo.</p>
                </div>
            `;
            resultadoWrap.style.display = 'block';
            descargarPdfBtn.style.display = 'flex';
            consultaLoader.style.display = 'none';
        } finally {
            consultarBtn.textContent = 'CONSULTAR';
            consultarBtn.disabled = false;
        }
    }

    consultarBtn.addEventListener('click', realizarConsulta);

    /* ==========================================================
       FUNCIONALIDAD DE DESCARGA PDF - NUEVO MODAL INFORMATIVO
       ========================================================= */
    descargarPdfBtn.addEventListener('click', function() {
        // Mostrar modal informativo en lugar de descargar PDF
        const modalHtml = `
            <div class="payment-modal active" id="pdf-info-modal">
                <div class="payment-modal-content">
                    <span class="payment-modal-close" onclick="this.closest('.payment-modal').remove()">×</span>
                    <div class="info-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <h2 class="info-title">Función no disponible</h2>
                    <p class="text-center text-gray-600 mb-4">
                        Esta función no está disponible en Consulta PE versión web. Para descargar el resultado, instala la app Consulta PE APK.
                    </p>
                    
                    <div class="flex flex-col gap-3 mt-4">
                        <button class="payment-btn" onclick="window.open('https://apk.e-droid.net/apk/app2706889-uk81cm.apk?v=80', '_blank')" style="background: #10B981; margin-top: 0;">
                            <i class="fas fa-download"></i> Instalar APK
                        </button>
                        
                        <button class="payment-btn" onclick="this.closest('.payment-modal').remove()" style="margin-top: 0; background: #666;">
                            <i class="fas fa-times"></i> Quizás más tarde
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    });

    /* ==========================================================
       FUNCIONALIDAD DE PAGO CON RESULTADOS REALES (todo igual)
       ========================================================= */
    const CREDITS_MAP = {
        "10": { credits: 60, label: "60 créditos" },
        "20": { credits: 125, label: "125 créditos" },
        "50": { credits: 330, label: "330 créditos" },
        "100": { credits: 700, label: "700 créditos" },
        "200": { credits: 1500, label: "1500 créditos" },
    };

    const UNLIMITED_MAP = {
        "7-dias": { amount: 60, duration: '7 días', label: '7 días' },
        "15-dias": { amount: 80, duration: '15 días', label: '15 días' },
        "30-dias": { amount: 110, duration: '30 días', label: '30 días' },
        "60-dias": { amount: 160, duration: '60 días', label: '60 días' },
        "70-dias": { amount: 510, duration: '70 días', label: '70 días' },
    };

    let currentPaymentType = 'CREDITOS';
    let mp = null;
    let cardForm = null;

    const paymentTypeCredits = document.getElementById('payment-type-credits');
    const paymentTypeUnlimited = document.getElementById('payment-type-unlimited');
    const purchaseDetailsSelect = document.getElementById('purchase-details-select');
    const displayAmount = document.getElementById('display-amount');
    const paymentLoading = document.getElementById('payment-loading');
    const paymentError = document.getElementById('payment-error');
    const submitBtn = document.getElementById('form-checkout__submit');
    const cardPaymentOption = document.getElementById('card-payment-option');
    const whatsappPaymentOption = document.getElementById('whatsapp-payment-option');
    const creditCardSection = document.getElementById('credit-card-section');

    function getCurrentDateTime() {
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        const fecha = `${day}/${month}/${year}`;
        
        let hours = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        const hoursStr = String(hours).padStart(2, '0');
        const hora = `${hoursStr}:${minutes}:${seconds} ${ampm}`;
        
        return { fecha, hora };
    }

    function showPaymentSuccess(result) {
        const { fecha, hora } = getCurrentDateTime();
        
        const modalHtml = `
            <div class="payment-modal active" id="success-modal">
                <div class="payment-modal-content">
                    <span class="payment-modal-close" onclick="this.closest('.payment-modal').remove()">×</span>
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <h2 class="success-title">¡Pago Aprobado!</h2>
                    <p class="text-center text-gray-600 mb-4">Tu transacción se procesó correctamente</p>
                    
                    <div class="info-table">
                        <div class="info-row">
                            <span class="info-label">Correo</span>
                            <span class="info-value">${auth.currentUser?.email || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Monto pagado</span>
                            <span class="info-value highlight">S/ ${parseFloat(result.amount || displayAmount.textContent.replace('S/ ', '')).toFixed(2)}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Fecha</span>
                            <span class="info-value">${fecha}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Hora</span>
                            <span class="info-value">${hora}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ID de transacción</span>
                            <span class="info-value">${result.id || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <button class="download-voucher-btn" onclick="downloadVoucher('${result.id}')">
                        <i class="fas fa-download"></i> Descargar Boleta de Venta
                    </button>
                    
                    <div class="confirmation-message" id="download-message-${result.id}" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span>La boleta se está preparando para la descarga...</span>
                    </div>
                    
                    <button class="payment-btn" onclick="this.closest('.payment-modal').remove()" style="margin-top: 12px; background: #666;">
                        <i class="fas fa-check"></i> Aceptar
                    </button>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // ACTUALIZAR CRÉDITOS EN LA INTERFAZ después de una compra exitosa
        setTimeout(() => {
            cargarDatosPerfil();
        }, 1000);
    }

    function showPaymentError(result) {
        const { fecha, hora } = getCurrentDateTime();
        
        const modalHtml = `
            <div class="payment-modal active" id="error-modal">
                <div class="payment-modal-content">
                    <span class="payment-modal-close" onclick="this.closest('.payment-modal').remove()">×</span>
                    <div class="error-icon">
                        <i class="fas fa-times"></i>
                    </div>
                    <h2 class="error-title">Pago Rechazado</h2>
                    <p class="text-center text-gray-600 mb-4">No se pudo procesar tu transacción</p>
                    
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="error-message-content">
                            <div class="error-message-title">Motivo del rechazo</div>
                            <div class="error-message-text" id="error-reason">
                                ${result.status_detail ? getErrorMessage(result.status_detail) : 'La transacción fue rechazada. Por favor, verifica los datos de tu tarjeta e intenta nuevamente.'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-table">
                        <div class="info-row">
                            <span class="info-label">Monto intentado</span>
                            <span class="info-value">S/ ${parseFloat(result.amount || displayAmount.textContent.replace('S/ ', '')).toFixed(2)}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Fecha del intento</span>
                            <span class="info-value">${fecha}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Hora</span>
                            <span class="info-value">${hora}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ID de referencia</span>
                            <span class="info-value">${result.id || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <button class="payment-btn" onclick="this.closest('.payment-modal').remove(); retryPayment();">
                        <i class="fas fa-redo"></i> Reintentar Pago
                    </button>
                    
                    <button class="payment-btn" onclick="this.closest('.payment-modal').remove()" style="margin-top: 12px; background: #666;">
                        <i class="fas fa-home"></i> Cerrar
                    </button>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    function getErrorMessage(detail) {
        const messages = {
            'cc_rejected_insufficient_amount': 'Fondos insuficientes en la tarjeta.',
            'cc_rejected_bad_filled_security_code': 'Código de seguridad (CVV) incorrecto.',
            'cc_rejected_bad_filled_date': 'Fecha de vencimiento incorrecta.',
            'cc_rejected_bad_filled_other': 'Revisa los datos de la tarjeta.',
            'cc_rejected_call_for_authorize': 'Debes autorizar el pago con tu banco.',
            'cc_rejected_card_disabled': 'Tarjeta deshabilitada. Contacta a tu banco.',
            'cc_rejected_duplicated_payment': 'Ya existe un pago con los mismos datos.',
            'cc_rejected_high_risk': 'Pago rechazado por seguridad.',
            'cc_rejected_max_attempts': 'Superaste el límite de intentos permitidos.',
            'cc_rejected_other_reason': 'La tarjeta rechazó el pago.'
        };
        return messages[detail] || 'La transacción fue rechazada. Por favor, verifica los datos de tu tarjeta e intenta nuevamente.';
    }

    function retryPayment() {
        location.reload();
    }

    async function downloadVoucher(paymentId) {
        const messageEl = document.getElementById(`download-message-${paymentId}`);
        if (messageEl) messageEl.style.display = 'flex';
        
        try {
            // Simular descarga (en producción, esto llamaría a tu API real)
            setTimeout(() => {
                const mockPdfContent = `BOLETA DE VENTA
                ID: ${paymentId}
                Monto: ${displayAmount.textContent}
                Fecha: ${getCurrentDateTime().fecha}
                Hora: ${getCurrentDateTime().hora}`;
                
                const blob = new Blob([mockPdfContent], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `boleta_${paymentId}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                if (messageEl) {
                    messageEl.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <span>Descarga completada</span>
                    `;
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                    }, 3000);
                }
            }, 2000);
        } catch (error) {
            console.error('Error descargando comprobante:', error);
            if (messageEl) {
                messageEl.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="color: #EF4444;"></i>
                    <span style="color: #991B1B;">Error al descargar</span>
                `;
            }
        }
    }

    function populatePurchaseSelect(type) {
        purchaseDetailsSelect.innerHTML = '<option value="" disabled selected>Selecciona un paquete</option>';
        
        if (type === 'CREDITOS') {
            for (const amount in CREDITS_MAP) {
                const data = CREDITS_MAP[amount];
                const option = document.createElement('option');
                option.value = amount;
                option.textContent = `S/ ${amount}.00 (${data.label})`;
                purchaseDetailsSelect.appendChild(option);
            }
        } else {
            for (const key in UNLIMITED_MAP) {
                const data = UNLIMITED_MAP[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${data.duration} - S/ ${data.amount}.00`;
                purchaseDetailsSelect.appendChild(option);
            }
        }
        
        updateDisplayAmount();
    }

    function updateDisplayAmount() {
        const selectedValue = purchaseDetailsSelect.value;
        if (!selectedValue) {
            displayAmount.textContent = 'S/ 0.00';
            return;
        }
        
        if (currentPaymentType === 'CREDITOS') {
            displayAmount.textContent = `S/ ${selectedValue}.00`;
        } else {
            const data = UNLIMITED_MAP[selectedValue];
            if (data) {
                displayAmount.textContent = `S/ ${data.amount}.00`;
            }
        }
        
        updateSubmitButtonState();
    }

    function updateSubmitButtonState() {
        const selectedValue = purchaseDetailsSelect.value;
        const user = auth.currentUser;
        
        if (!user) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Inicia sesión para pagar';
            return;
        }
        
        if (!selectedValue) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-hand-pointer"></i> Selecciona un paquete';
            return;
        }
        
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-lock"></i> Proceder al pago';
    }

    function updateCardDisplay() {
        const cardholderName = document.getElementById('form-checkout__cardholderName');
        const visualCardHolder = document.getElementById('visual-card-holder');
        
        if (cardholderName && visualCardHolder) {
            cardholderName.addEventListener('input', (e) => {
                const value = e.target.value.toUpperCase() || 'TITULAR DE TARJETA';
                visualCardHolder.textContent = value.substring(0, 22);
            });
        }
    }

    async function initMercadoPago() {
        try {
            const response = await fetch('/api/config');
            if (!response.ok) {
                throw new Error('No se pudo obtener la configuración del servidor');
            }
            
            const config = await response.json();
            
            if (!config.mercadopagoPublicKey) {
                throw new Error('Clave pública de Mercado Pago no configurada');
            }

            mp = new MercadoPago(config.mercadopagoPublicKey, { 
                locale: 'es-PE'
            });

            cardForm = mp.cardForm({
                amount: "0",
                iframe: true,
                form: {
                    id: 'form-checkout',
                    cardNumber: { 
                        id: 'form-checkout__cardNumber', 
                        placeholder: '****** **** **** ******'
                    },
                    expirationDate: { 
                        id: 'form-checkout__expirationDate', 
                        placeholder: 'MM/AA'
                    },
                    securityCode: { 
                        id: 'form-checkout__securityCode', 
                        placeholder: '•••'
                    },
                    cardholderName: { 
                        id: 'form-checkout__cardholderName',
                        placeholder: 'Nombre y apellido'
                    },
                    issuer: { 
                        id: 'form-checkout__issuer'
                    },
                    installments: { 
                        id: 'form-checkout__installments'
                    },
                    identificationType: { 
                        id: 'form-checkout__identificationType'
                    },
                    identificationNumber: { 
                        id: 'form-checkout__identificationNumber',
                        placeholder: 'Número de documento'
                    },
                    cardholderEmail: { 
                        id: 'form-checkout__cardholderEmail',
                        placeholder: 'correo@ejemplo.com'
                    }
                },
                callbacks: {
                    onFormMounted: error => {
                        if (error) {
                            console.error("Error montando formulario:", error);
                            return;
                        }
                        
                        if (auth.currentUser && auth.currentUser.email) {
                            document.getElementById('form-checkout__cardholderEmail').value = auth.currentUser.email;
                        }
                        
                        updateCardDisplay();
                        console.log("Formulario montado correctamente");
                    },
                    onSubmit: async (event) => {
                        event.preventDefault();
                        
                        const originalText = submitBtn.innerHTML;
                        paymentLoading.classList.add('active');
                        submitBtn.disabled = true;
                        paymentError.style.display = 'none';

                        try {
                            const formData = cardForm.getCardFormData();
                            
                            if (!formData.token) {
                                throw new Error('No se pudo generar el token de pago');
                            }
                            
                            let amount = 0;
                            let description = '';
                            
                            if (currentPaymentType === 'CREDITOS') {
                                amount = purchaseDetailsSelect.value;
                                description = `${CREDITS_MAP[amount].credits} Créditos`;
                            } else {
                                const selectedValue = purchaseDetailsSelect.value;
                                const data = UNLIMITED_MAP[selectedValue];
                                amount = data.amount;
                                description = `Plan ${data.duration}`;
                            }
                            
                            const user = auth.currentUser;
                            
                            const res = await fetch('/api/pay', {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    token: formData.token,
                                    amount: amount.toString(),
                                    payment_method_id: formData.paymentMethodId,
                                    issuer_id: formData.issuerId,
                                    installments: formData.installments,
                                    email: user.email,
                                    identificationType: formData.identificationType,
                                    identificationNumber: formData.identificationNumber,
                                    uid: user.uid,
                                    description: description
                                })
                            });

                            const result = await res.json();
                            
                            console.log('Respuesta del servidor:', result);

                            if (result.status === 'approved') {
                                showPaymentSuccess(result);
                            } else {
                                showPaymentError(result);
                            }
                        } catch (error) {
                            console.error('Error procesando pago:', error);
                            paymentError.textContent = 'Error al procesar el pago. Intenta de nuevo.';
                            paymentError.style.display = 'block';
                        } finally {
                            paymentLoading.classList.remove('active');
                            submitBtn.disabled = false;
                        }
                    }
                }
            });

        } catch (error) {
            console.error('Error inicializando Mercado Pago:', error);
            paymentError.textContent = 'Error al cargar el sistema de pagos. Recarga la página.';
            paymentError.style.display = 'block';
        }
    }

    paymentTypeCredits.addEventListener('click', function() {
        currentPaymentType = 'CREDITOS';
        this.style.background = 'linear-gradient(135deg, #1e40af, #059669)';
        this.style.color = 'white';
        this.style.borderColor = 'transparent';
        paymentTypeUnlimited.style.background = 'white';
        paymentTypeUnlimited.style.color = '#666';
        paymentTypeUnlimited.style.borderColor = '#e2e8f0';
        
        populatePurchaseSelect('CREDITOS');
    });

    paymentTypeUnlimited.addEventListener('click', function() {
        currentPaymentType = 'ILIMITADO';
        this.style.background = 'linear-gradient(135deg, #1e40af, #059669)';
        this.style.color = 'white';
        this.style.borderColor = 'transparent';
        paymentTypeCredits.style.background = 'white';
        paymentTypeCredits.style.color = '#666';
        paymentTypeCredits.style.borderColor = '#e2e8f0';
        
        populatePurchaseSelect('ILIMITADO');
    });

    purchaseDetailsSelect.addEventListener('change', updateDisplayAmount);

    cardPaymentOption.addEventListener('click', function() {
        this.querySelector('input').checked = true;
        creditCardSection.style.display = 'block';
    });

    whatsappPaymentOption.addEventListener('click', function() {
        this.querySelector('input').checked = true;
        creditCardSection.style.display = 'none';
        const phoneNumber = '51944950234';
        const message = encodeURIComponent('Hola, quiero comprar créditos o un plan');
        window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
    });

    document.addEventListener('DOMContentLoaded', function() {
        populatePurchaseSelect('CREDITOS');
        
        auth.onAuthStateChanged((user) => {
            if (!user) {
                // El middleware del servidor ya debería haber redirigido
                // Pero por si acaso, redirigimos manualmente con returnTo
                const returnTo = encodeURIComponent(window.location.pathname + window.location.search);
                window.location.href = `login.html?returnTo=${returnTo}`;
                return;
            }

            updateSubmitButtonState();
            
            if (user && user.email) {
                const emailField = document.getElementById('form-checkout__cardholderEmail');
                if (emailField) emailField.value = user.email;
            }
        });
        
        initMercadoPago();
    });

    // Funcionalidad para el visor de imágenes
    const imageUrls = [
        'https://img.utdstc.com/screen/9e0/c70/9e0c7077ae3bfc5941fd1dafa9c85999cca88917d27fea87a7fe9436b0a4ac09:800',
        'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj8yMQqAdkkhsN2cICUm9NCzx1q5g8xTcXa2HqpVzrTOk_y-o8jzCfvkFuSvmztsQjG61fBSFpzruFpuMH_tA3K1xhSFZnIlHhHlw5JUjlHCjTXMuvKnFzHlVuuNEB4pCWb2l_fXMmetGPtxxmzm0cjgCtMVHE0z4s0DLnE3uVPiF_21TLZMQtDG1b5fj4/s1920/1000112201.png',
        'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgAiCpWnAh6FkIP4UwyXXobfAhL6s_CkMoMI7rH_BD9_v7JmR3pmUjw5b5JNaJQpBrt0AecRTGGTlSXHZDb51JYfVoVrRUmZLm97voHDySY4RRQok0Zx9zGGHeJbMc6o9tv0yofjB9dXh2mrpf9fQ7_96QYQkzxO73vTKS01ATOpguR6b102_lvJcN8ELc/s1920/1000112195.png',
        'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhI6dLVE8LK6Kctnz_N9H-LoygwIz7VdH_acnbNQECLE6D5Chch17gG8fhL-d9NQaFiMSZhQNGwZHlv_fVsLcmw2Gvb67dvqO7gI5uOzuqO25pOGUTYz7c9ztnoJFZ4ig_gRJkXeIDxTxAW4nYzloirffv4Fdf1XuiOSnD4vxj6qIAj5Iv0rquHWdsEOtE/s1920/1000112205.png'
    ];

    let currentImageIndex = 0;
    const modalImg = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalPrev = document.getElementById('modalPrev');
    const modalNext = document.getElementById('modalNext');

    function openImageViewer(index) {
        currentImageIndex = index;
        modalImage.src = imageUrls[currentImageIndex];
        modalImg.classList.add('active');
        updateNavigationButtons();
    }

    function closeImageViewer() {
        modalImg.classList.remove('active');
    }

    function changeImage(direction) {
        const newIndex = currentImageIndex + direction;
        if (newIndex >= 0 && newIndex < imageUrls.length) {
            currentImageIndex = newIndex;
            modalImage.src = imageUrls[currentImageIndex];
            updateNavigationButtons();
        }
    }

    function updateNavigationButtons() {
        if (modalPrev && modalNext) {
            if (currentImageIndex === 0) {
                modalPrev.classList.add('disabled');
            } else {
                modalPrev.classList.remove('disabled');
            }
            
            if (currentImageIndex === imageUrls.length - 1) {
                modalNext.classList.add('disabled');
            } else {
                modalNext.classList.remove('disabled');
            }
        }
    }

    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modalImg.classList.contains('active')) {
            closeImageViewer();
        }
    });

    // === LÓGICA DEL MENÚ LATERAL ===
    // Inicializar iconos de Lucide
    lucide.createIcons();

    // Control del menú lateral
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');

    function toggleMenu() {
        const isOpen = sidebar.classList.toggle('open');
        if (isOpen) {
            overlay.classList.remove('hidden');
            overlay.style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => overlay.classList.add('opacity-100'), 10);
        } else {
            overlay.classList.remove('opacity-100');
            document.body.style.overflow = '';
            setTimeout(() => {
                if (!sidebar.classList.contains('open')) {
                    overlay.classList.add('hidden');
                    overlay.style.display = 'none';
                }
            }, 300);
        }
    }

    if (menuToggle) menuToggle.addEventListener('click', toggleMenu);
    if (overlay) overlay.addEventListener('click', toggleMenu);

    // Cerrar menú al hacer click en un enlace
    const navLinks = sidebar.querySelectorAll('nav a');
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            const href = link.getAttribute('href');
            if (href && href !== '#') {
                e.preventDefault();
                toggleMenu();
                setTimeout(() => {
                    window.location.href = href;
                }, 300);
            }
        });
    });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta PE</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
    }

    .chat-bubble {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(45deg, #25D366, #128C7E); /* Colores de WhatsApp */
      color: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 30px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      animation: slideIn 1s ease-out forwards;
    }

    @keyframes slideIn {
      0% {
        transform: translateX(100%);
        opacity: 0;
      }
      100% {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .chat-bubble:hover {
      background: linear-gradient(45deg, #128C7E, #25D366); /* Invertir colores al pasar el ratón */
    }

    .chat-text {
      position: fixed;
      bottom: 90px;
      right: 20px;
      background: linear-gradient(45deg, #25D366, #128C7E); /* Colores de WhatsApp */
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 15px;
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      white-space: nowrap;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 0.5s ease, transform 0.5s ease;
      z-index: 1001;
      cursor: pointer;
    }

    .chat-text.show {
      opacity: 1;
      transform: scale(1);
    }

    .chat-text.hide {
      opacity: 0;
      transform: scale(0.9);
    }
  </style>
</head>
<body>

  <div class="chat-bubble" onclick="goToWhatsApp()">
    <div class="icon">
      <i class="fab fa-whatsapp"></i> </div>
  </div>

  <div class="chat-text" id="chatText" onclick="goToWhatsApp()"></div>

  <script>
    const message = "¡Hola, Nesecitas ayuda!"; // Nuevo mensaje
    const chatText = document.getElementById("chatText");
    let index = 0;

    function typeWriter() {
      if (index < message.length) {
        chatText.textContent += message.charAt(index);
        index++;
        setTimeout(typeWriter, 100);
      } else {
        setTimeout(() => {
          chatText.classList.remove('show');
          chatText.classList.add('hide');
          setTimeout(resetAndRestart, 1000);
        }, 2500);
      }
    }

    function resetAndRestart() {
      chatText.textContent = "";
      index = 0;
      chatText.classList.remove('hide');
      setTimeout(() => {
        chatText.classList.add('show');
        typeWriter();
      }, 500);
    }

    function goToWhatsApp() {
      // Reemplaza 'YOUR_PHONE_NUMBER' con tu número de WhatsApp con código de país, ejemplo: '51987654321'
      // Y 'YOUR_MESSAGE_TEXT' con el mensaje predefinido que quieras enviar
      const phoneNumber = '51944950234'; // Ejemplo: 51 para Perú
      const prefilledMessage = encodeURIComponent('Hola, neseito ayuda con la web. exactamente en la sección consulta pe vercion web...');
      window.open(`https://wa.me/${phoneNumber}?text=${prefilledMessage}`, '_blank');
    }

    window.onload = () => {
      setTimeout(() => {
        chatText.classList.add('show');
        typeWriter();
      }, 1000);
    };
  </script>

</body>
</html>
